<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Hexo</title>
  
  <subtitle>A fast, simple &amp; powerful blog framework powered by Node.js.</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://hexo.io/"/>
  <updated>2019-01-12T07:19:20.000Z</updated>
  <id>https://hexo.io/</id>
  
  <author>
    <name>Hexo</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Integrate tengine with libressl to support chacha20-ietf-poly1305</title>
    <link href="https://hexo.io/news/2019/01/09/Integrate-tengine-with-libressl-to-support-chacha20-ietf-poly1305.html"/>
    <id>https://hexo.io/news/2019/01/09/Integrate-tengine-with-libressl-to-support-chacha20-ietf-poly1305.html</id>
    <published>2019-01-08T16:00:00.000Z</published>
    <updated>2019-01-12T07:19:20.000Z</updated>
    
    <content type="html"><![CDATA[<hr><h2 id="更换背景"><a href="#更换背景" class="headerlink" title="更换背景"></a>更换背景</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Mac 基础套件ssh, php以及alpine Linux已经切换openssl到libressl</span></span><br><span class="line">➜  ~ ssh -V</span><br><span class="line">OpenSSH_7.8p1, LibreSSL 2.6.2</span><br><span class="line"></span><br><span class="line">➜  ~ php -i</span><br><span class="line">phpinfo()</span><br><span class="line">PHP Version =&gt; 7.1.16</span><br><span class="line"></span><br><span class="line">root:xnu-4570.71.17~1/RELEASE_X86_64 x86_64</span><br><span class="line">Build Date =&gt; Apr  1 2018 13:47:29</span><br><span class="line">Configure Command =&gt; <span class="string">'....</span></span><br><span class="line"><span class="string">--with-openssl=/BuildRoot/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.13.Internal.sdk/usr/local/libressl</span></span><br><span class="line"><span class="string">...'</span></span><br></pre></td></tr></table></figure><h2 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明"></a>环境说明</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat /etc/redhat-release</span><br><span class="line">CentOS Linux release 7.6.1810 (Core)</span><br><span class="line"></span><br><span class="line">$ uname -a</span><br><span class="line">Linux izj6c0ahnyudgp7qwa7ah8z 4.14.90 <span class="comment">#1 SMP Mon Dec 24 04:50:20 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux</span></span><br></pre></td></tr></table></figure><h2 id="编译libressl"><a href="#编译libressl" class="headerlink" title="编译libressl"></a>编译libressl</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src/</span><br><span class="line">wget -c https://ftp.openbsd.org/pub/OpenBSD/LibreSSL/libressl-2.6.5.tar.gz</span><br><span class="line"><span class="comment"># centos 7 gcc需要额外设置编译参数-fPIC</span></span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src/libressl/</span><br><span class="line"><span class="built_in">export</span> CFLAGS=<span class="string">"<span class="variable">$CFLAGS</span> -fPIC -g -O2"</span> &amp;&amp; ./config --prefix=/usr/<span class="built_in">local</span>/src/libressl/.openssl no-shared</span><br><span class="line">make -j4 &amp;&amp; make install-strip distclean</span><br><span class="line"><span class="built_in">unset</span> CFLAGS</span><br></pre></td></tr></table></figure><h2 id="编译tengine，使用libressl"><a href="#编译tengine，使用libressl" class="headerlink" title="编译tengine，使用libressl"></a>编译tengine，使用libressl</h2><hr><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src/tengine/</span><br><span class="line">make clean</span><br><span class="line"></span><br><span class="line">./configure \</span><br><span class="line">--prefix=/usr/share/nginx \</span><br><span class="line">--conf-path=/etc/nginx/nginx.conf \</span><br><span class="line">--error-log-path=/var/<span class="built_in">log</span>/nginx/error.log \</span><br><span class="line">--http-client-body-temp-path=/var/cache/nginx/client_temp \</span><br><span class="line">--http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp \</span><br><span class="line">--http-log-path=/var/<span class="built_in">log</span>/nginx/access.log \</span><br><span class="line">--http-proxy-temp-path=/var/cache/nginx/proxy_temp \</span><br><span class="line">--http-scgi-temp-path=/var/cache/nginx/scgi_temp \</span><br><span class="line">--http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp \</span><br><span class="line">--lock-path=/var/run/lock/nginx.lock \</span><br><span class="line">--pid-path=/var/run/nginx.pid \</span><br><span class="line">--sbin-path=/usr/sbin/nginx \</span><br><span class="line">--dso-tool-path=/usr/sbin/dso_tool \</span><br><span class="line">--group=nginx \</span><br><span class="line">--user=nginx \</span><br><span class="line">--with-file-aio \</span><br><span class="line">--with-http_addition_module=shared \</span><br><span class="line">--with-http_auth_request_module \</span><br><span class="line">--with-http_concat_module=shared \</span><br><span class="line">--with-http_dav_module \</span><br><span class="line">--with-http_degradation_module \</span><br><span class="line">--with-http_dyups_module \</span><br><span class="line">--with-http_flv_module=shared \</span><br><span class="line">--with-http_geoip_module=shared \</span><br><span class="line">--with-http_gunzip_module \</span><br><span class="line">--with-http_gzip_static_module \</span><br><span class="line">--with-http_memcached_module=shared \</span><br><span class="line">--with-http_random_index_module=shared \</span><br><span class="line">--with-http_realip_module \</span><br><span class="line">--with-http_reqstat_module=shared \</span><br><span class="line">--with-http_secure_link_module=shared \</span><br><span class="line">--with-http_slice_module=shared \</span><br><span class="line">--with-http_sub_module=shared \</span><br><span class="line">--with-http_sysguard_module=shared \</span><br><span class="line">--with-http_v2_module \</span><br><span class="line">--with-ipv6 \</span><br><span class="line">--with-jemalloc \</span><br><span class="line">--with-http_xslt_module=shared \</span><br><span class="line">--with-pcre \</span><br><span class="line">--with-pcre-jit \</span><br><span class="line">--with-openssl=/usr/<span class="built_in">local</span>/src/libressl \</span><br><span class="line">--with-cc-opt=<span class="string">'-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=native -fPIC'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新libressl header文件时间戳防止再次编译</span></span><br><span class="line">touch /usr/<span class="built_in">local</span>/src/libressl/.openssl/include/openssl/ssl.h</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译安装</span></span><br><span class="line">make -j3 &amp;&amp; sudo make install clean &amp;&amp; sudo mkdir -pv /var/cache/nginx/client_temp</span><br></pre></td></tr></table></figure><h2 id="启动脚本"><a href="#启动脚本" class="headerlink" title="启动脚本"></a>启动脚本</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@nat-gw-jms-254-2 ~]<span class="comment"># cat &gt; /usr/lib/systemd/system/nginx.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=The nginx HTTP and reverse proxy server</span><br><span class="line">After=network.target remote-fs.target nss-lookup.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">PIDFile=/run/nginx.pid</span><br><span class="line"><span class="comment"># Nginx will fail to start if /run/nginx.pid already exists but has the wrong</span></span><br><span class="line"><span class="comment"># SELinux context. This might happen when running `nginx -t` from the cmdline.</span></span><br><span class="line"><span class="comment"># https://bugzilla.redhat.com/show_bug.cgi?id=1268621</span></span><br><span class="line">ExecStartPre=/usr/bin/rm -f /run/nginx.pid</span><br><span class="line">ExecStartPre=/usr/sbin/nginx -t</span><br><span class="line">ExecStart=/usr/sbin/nginx</span><br><span class="line">ExecReload=/bin/<span class="built_in">kill</span> -s HUP <span class="variable">$MAINPID</span></span><br><span class="line">KillSignal=SIGQUIT</span><br><span class="line">TimeoutStopSec=5</span><br><span class="line">KillMode=process</span><br><span class="line">PrivateTmp=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h2 id="额外设置"><a href="#额外设置" class="headerlink" title="额外设置"></a>额外设置</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">chkconfig nginx on</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;hr&gt;
&lt;h2 id=&quot;更换背景&quot;&gt;&lt;a href=&quot;#更换背景&quot; class=&quot;headerlink&quot; title=&quot;更换背景&quot;&gt;&lt;/a&gt;更换背景&lt;/h2&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;
      
    
    </summary>
    
    
  </entry>
  
</feed>
