<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>W0ng.Unic0rn blog</title>
  
  <subtitle>A fast, simple &amp; powerful blog framework powered by Node.js.</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://hexo.io/"/>
  <updated>2019-01-13T06:01:15.000Z</updated>
  <id>https://hexo.io/</id>
  
  <author>
    <name>W0ng.Unic0rn</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>speedup typecho using memcached</title>
    <link href="https://hexo.io/news/2019/01/13/2019-01-13-speedup-typecho-using-memcached.html"/>
    <id>https://hexo.io/news/2019/01/13/2019-01-13-speedup-typecho-using-memcached.html</id>
    <published>2019-01-13T05:42:21.000Z</published>
    <updated>2019-01-13T06:01:15.000Z</updated>
    
    <content type="html"><![CDATA[<hr><h2 id="安装libmemcached"><a href="#安装libmemcached" class="headerlink" title="安装libmemcached"></a>安装libmemcached</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install cyrus-sasl-devel -y</span><br><span class="line">wget https://launchpad.net/libmemcached/1.0/1.0.18/+download/libmemcached-1.0.18.tar.gz</span><br><span class="line">tar zxf libmemcached-1.0.18.tar.gz</span><br><span class="line"><span class="built_in">cd</span> libmemcached-1.0.18</span><br><span class="line">./configure --libdir=/usr/lib64</span><br><span class="line">make</span><br><span class="line">make install clean</span><br><span class="line">ldconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># ll /usr/lib64/libmemcached* -th</span></span><br><span class="line">-rw-r--r-- 1 root root 212K Jan 14 19:01 /usr/lib64/libmemcachedutil.a</span><br><span class="line">-rw-r--r-- 1 root root 2.9M Jan 14 19:01 /usr/lib64/libmemcached.a</span><br><span class="line">-rwxr-xr-x 1 root root 1.1K Jan 14 19:01 /usr/lib64/libmemcachedutil.la</span><br><span class="line">lrwxrwxrwx 1 root root   25 Jan 14 19:01 /usr/lib64/libmemcachedutil.so -&gt; libmemcachedutil.so.2.0.0</span><br><span class="line">lrwxrwxrwx 1 root root   25 Jan 14 19:01 /usr/lib64/libmemcachedutil.so.2 -&gt; libmemcachedutil.so.2.0.0</span><br><span class="line">-rwxr-xr-x 1 root root 111K Jan 14 19:01 /usr/lib64/libmemcachedutil.so.2.0.0</span><br><span class="line">-rwxr-xr-x 1 root root  974 Jan 14 19:01 /usr/lib64/libmemcached.la</span><br><span class="line">lrwxrwxrwx 1 root root   22 Jan 14 19:01 /usr/lib64/libmemcached.so -&gt; libmemcached.so.11.0.0</span><br><span class="line">lrwxrwxrwx 1 root root   22 Jan 14 19:01 /usr/lib64/libmemcached.so.11 -&gt; libmemcached.so.11.0.0</span><br><span class="line">-rwxr-xr-x 1 root root 1.3M Jan 14 19:01 /usr/lib64/libmemcached.so.11.0.0</span><br><span class="line">lrwxrwxrwx 1 root root   25 Jan 14 18:31 /usr/lib64/libmemcachedutil.so.0 -&gt; libmemcachedutil.so.0.0.0</span><br><span class="line">lrwxrwxrwx 1 root root   21 Jan 14 18:31 /usr/lib64/libmemcached.so.2 -&gt; libmemcached.so.2.0.0</span><br><span class="line">-rwxr-xr-x 1 root root  64K Nov 12  2010 /usr/lib64/libmemcached.so.2.0.0</span><br><span class="line">-rwxr-xr-x 1 root root 6.9K Nov 12  2010 /usr/lib64/libmemcachedutil.so.0.0.0</span><br></pre></td></tr></table></figure><h2 id="安装php-memcached"><a href="#安装php-memcached" class="headerlink" title="安装php-memcached"></a>安装php-memcached</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/production/server/php/bin/phpize</span><br><span class="line">./configure --with-php-config=/production/server/php/bin/php-config --<span class="built_in">enable</span>-memcached --<span class="built_in">enable</span>-memcached-json</span><br><span class="line">make -j2</span><br><span class="line">make install clean</span><br><span class="line"></span><br><span class="line">Installing shared extensions:     /production/server/php/lib/php/extensions/no-debug-non-zts-20131226/</span><br><span class="line">find . -name \*.gcno -o -name \*.gcda | xargs rm -f</span><br><span class="line">find . -name \*.lo -o -name \*.o | xargs rm -f</span><br><span class="line">find . -name \*.la -o -name \*.a | xargs rm -f</span><br><span class="line">find . -name \*.so | xargs rm -f</span><br><span class="line">find . -name .libs -a -<span class="built_in">type</span> d|xargs rm -rf</span><br><span class="line">rm -f libphp.la       modules/* libs/*</span><br></pre></td></tr></table></figure><h2 id="打开扩展"><a href="#打开扩展" class="headerlink" title="打开扩展"></a>打开扩展</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vim php/etc/php.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加以下配置</span></span><br><span class="line">[memcached]</span><br><span class="line">extension=memcached.so</span><br><span class="line"></span><br><span class="line">sbin/php-fpm -t</span><br><span class="line">[14-Jan-2018 19:13:55] NOTICE: configuration file /production/server/php/etc/php-fpm.conf <span class="built_in">test</span> is successful</span><br><span class="line"></span><br><span class="line"><span class="comment"># service php-fpm reload</span></span><br><span class="line"><span class="comment"># /production/server/php/bin/php -m | grep memcached</span></span><br><span class="line">memcached</span><br></pre></td></tr></table></figure><h2 id="安装配置memcached"><a href="#安装配置memcached" class="headerlink" title="安装配置memcached"></a>安装配置memcached</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install memcached -y</span><br><span class="line">diff /etc/sysconfig/memcached /etc/sysconfig/memcached.ori</span><br><span class="line">5c5</span><br><span class="line">&lt; OPTIONS=<span class="string">"-l 127.0.0.1"</span></span><br><span class="line">---</span><br><span class="line">&gt; OPTIONS=<span class="string">""</span></span><br></pre></td></tr></table></figure><h2 id="安装插件"><a href="#安装插件" class="headerlink" title="安装插件"></a>安装插件</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/phpgao/TpCache.git</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;hr&gt;
&lt;h2 id=&quot;安装libmemcached&quot;&gt;&lt;a href=&quot;#安装libmemcached&quot; class=&quot;headerlink&quot; title=&quot;安装libmemcached&quot;&gt;&lt;/a&gt;安装libmemcached&lt;/h2&gt;&lt;figure class=&quot;highl
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>nginx proxy_pass keepalive settings</title>
    <link href="https://hexo.io/news/2019/01/13/2019-01-13-nginx-proxy-pass-keepalive-settings.html"/>
    <id>https://hexo.io/news/2019/01/13/2019-01-13-nginx-proxy-pass-keepalive-settings.html</id>
    <published>2019-01-13T02:18:08.000Z</published>
    <updated>2019-01-13T02:30:42.000Z</updated>
    
    <content type="html"><![CDATA[<hr><h2 id="抓包"><a href="#抓包" class="headerlink" title="抓包"></a>抓包</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ngrep -d lo -W byline 'GET /' 'tcp and dst port 6000'</span></span><br></pre></td></tr></table></figure><h3 id="原始返回"><a href="#原始返回" class="headerlink" title="原始返回"></a>原始返回</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">T 127.0.0.1:33310 -&gt; 127.0.0.1:6000 [AP]</span><br><span class="line">GET / HTTP/1.1.</span><br><span class="line">Host: www.example.com.</span><br><span class="line">X-Real-IP: 1.2.3.4</span><br><span class="line">X-Forwarded-For: 1.2.3.4</span><br><span class="line">--&gt; Connection: close.</span><br><span class="line">upgrade-insecure-requests: 1.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认发送header Connection: close.</span></span><br></pre></td></tr></table></figure><h2 id="打开upstream的keepalive"><a href="#打开upstream的keepalive" class="headerlink" title="打开upstream的keepalive"></a>打开upstream的keepalive</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">upstream node_svr_learntadotcom &#123;</span><br><span class="line">server 127.0.0.1:6000;</span><br><span class="line">--&gt; keepalive 32;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="返回内容没有变化"><a href="#返回内容没有变化" class="headerlink" title="返回内容没有变化"></a>返回内容没有变化</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">T 127.0.0.1:33956 -&gt; 127.0.0.1:6000 [AP]</span><br><span class="line">GET / HTTP/1.1.</span><br><span class="line">Host: www.example.com.</span><br><span class="line">X-Real-IP: 1.2.3.4</span><br><span class="line">X-Forwarded-For: 1.2.3.4</span><br><span class="line">--&gt; Connection: close.</span><br><span class="line">upgrade-insecure-requests: 1.</span><br></pre></td></tr></table></figure><h2 id="打开location中的proxy-http-version"><a href="#打开location中的proxy-http-version" class="headerlink" title="打开location中的proxy_http_version"></a>打开location中的proxy_http_version</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">proxy_http_version 1.1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="问题依旧"><a href="#问题依旧" class="headerlink" title="问题依旧"></a>问题依旧</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">T 127.0.0.1:34746 -&gt; 127.0.0.1:6000 [AP]</span><br><span class="line">GET / HTTP/1.1.</span><br><span class="line">Host: www.example.com.</span><br><span class="line">X-Real-IP: 1.2.3.4</span><br><span class="line">X-Forwarded-For: 1.2.3.4</span><br><span class="line">--&gt; Connection: close.</span><br><span class="line">upgrade-insecure-requests: 1.</span><br></pre></td></tr></table></figure><h2 id="打开location中的proxy-set-header"><a href="#打开location中的proxy-set-header" class="headerlink" title="打开location中的proxy_set_header"></a>打开location中的proxy_set_header</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">proxy_set_header Connection <span class="string">""</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="返回不再包含Connection-close，打开长连接成功"><a href="#返回不再包含Connection-close，打开长连接成功" class="headerlink" title="返回不再包含Connection: close，打开长连接成功"></a>返回不再包含Connection: close，打开长连接成功</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">T 127.0.0.1:35342 -&gt; 127.0.0.1:6000 [AP]</span><br><span class="line">GET / HTTP/1.1.</span><br><span class="line">Host: www.example.com.</span><br><span class="line">X-Real-IP: 1.2.3.4</span><br><span class="line">X-Forwarded-For: 1.2.3.4</span><br><span class="line">cache-control: max-age=0.</span><br><span class="line">upgrade-insecure-requests: 1.</span><br></pre></td></tr></table></figure><h3 id="短时间内再次刷新"><a href="#短时间内再次刷新" class="headerlink" title="短时间内再次刷新"></a>短时间内再次刷新</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">T 127.0.0.1:35342 -&gt; 127.0.0.1:6000 [AP]</span><br><span class="line">GET / HTTP/1.1.</span><br><span class="line">Host: www.example.com.</span><br><span class="line">X-Real-IP: 1.2.3.4.</span><br><span class="line">X-Forwarded-For: 1.2.3.4.</span><br><span class="line">cache-control: max-age=0.</span><br><span class="line">upgrade-insecure-requests: 1.</span><br><span class="line"></span><br><span class="line"><span class="comment"># client端的端口依旧是35342</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;hr&gt;
&lt;h2 id=&quot;抓包&quot;&gt;&lt;a href=&quot;#抓包&quot; class=&quot;headerlink&quot; title=&quot;抓包&quot;&gt;&lt;/a&gt;抓包&lt;/h2&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;spa
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>build shadowsocks-libev rpm pkgs on centos7</title>
    <link href="https://hexo.io/news/2019/01/13/2019-01-13-build-shadowsocks-libev-rpm-pkgs-on-centos7.html"/>
    <id>https://hexo.io/news/2019/01/13/2019-01-13-build-shadowsocks-libev-rpm-pkgs-on-centos7.html</id>
    <published>2019-01-13T01:41:47.000Z</published>
    <updated>2019-01-19T06:26:29.000Z</updated>
    
    <content type="html"><![CDATA[<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># dependency</span></span><br><span class="line">$ sudo yum install rpm-build c-ares-devel openssl-devel libev-devel libtool automake xmlto asciidoc pcre-devel -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># gen shadowsocks-libev.src.rpm</span></span><br><span class="line">$ <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src/shadowsocks-libev/rpm/</span><br><span class="line">$ ./genrpm.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># gen shadowsocks-libev.spec</span></span><br><span class="line">$ rpm -ivh SRPMS/shadowsocks-libev-3.2.3-1.10.gitbbc4206.src.rpm</span><br><span class="line">Updating / installing...</span><br><span class="line">   1:shadowsocks-libev-3.2.3-1.10.gitb<span class="comment">################################# [100%]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># install libsodium-devel</span></span><br><span class="line">$ <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src/</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/totemofwolf/rpmbuild4all.git</span><br><span class="line">$ <span class="built_in">cd</span> rpmbuild4all/</span><br><span class="line">$ wget -c https://download.libsodium.org/libsodium/releases/libsodium-1.0.16.tar.gz -O ~/rpmbuild/SOURCES/libsodium-1.0.16.tar.gz</span><br><span class="line">$ rpmbuild -bb ./SPECS/libsodium.spec</span><br><span class="line">$ sudo rpm -ivh rpmbuild/RPMS/x86_64/libsodium-devel-1.0.16-1.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment"># build shadowsocks-libev</span></span><br><span class="line">$ rpmbuild -bb ~/rpmbuild/SPECS/shadowsocks-libev.spec</span><br><span class="line">$ sudo yum localinstall shadowsocks-libev-zsh-completion-3.2.3-1.10.gitbbc4206.el7.x86_64.rpm shadowsocks-libev-3.2.3-1.10.gitbbc4206.el7.x86_64.rpm -y</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# dep
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>redis cluster on centos7</title>
    <link href="https://hexo.io/news/2019/01/13/2019-01-13-redis-cluster-on-centos7.html"/>
    <id>https://hexo.io/news/2019/01/13/2019-01-13-redis-cluster-on-centos7.html</id>
    <published>2019-01-12T17:04:03.000Z</published>
    <updated>2019-01-12T17:07:34.000Z</updated>
    
    <content type="html"><![CDATA[<ul><li>ref:</li></ul><p><a href="https://www.jianshu.com/p/d562ce7c344b" target="_blank" rel="noopener">https://www.jianshu.com/p/d562ce7c344b</a></p><p>ruby 2.2.x on centos7</p><p><a href="https://blog.csdn.net/liu0808/article/details/80098568" target="_blank" rel="noopener">https://blog.csdn.net/liu0808/article/details/80098568</a></p><hr><h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">- 启动</span><br><span class="line">$ <span class="keyword">for</span> i <span class="keyword">in</span> `ls`; <span class="keyword">do</span> screen -dmS redis_<span class="variable">$i</span> /usr/<span class="built_in">local</span>/bin/redis-server <span class="variable">$i</span>/redis.conf; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">pwd</span></span><br><span class="line">/tmp/redis-4.0.12/src</span><br><span class="line"></span><br><span class="line">- 本机集群：</span><br><span class="line">$ ./redis-trib.rb create --replicas 1 127.0.0.1:6379 127.0.0.1:6380 127.0.0.1:6381 127.0.0.1:6382 127.0.0.1:6383 127.0.0.1:6384</span><br><span class="line">&gt;&gt;&gt; Creating cluster</span><br><span class="line">&gt;&gt;&gt; Performing <span class="built_in">hash</span> slots allocation on 6 nodes...</span><br><span class="line">Using 3 masters:</span><br><span class="line">127.0.0.1:6379</span><br><span class="line">127.0.0.1:6380</span><br><span class="line">127.0.0.1:6381</span><br><span class="line">Adding replica 127.0.0.1:6383 to 127.0.0.1:6379</span><br><span class="line">Adding replica 127.0.0.1:6384 to 127.0.0.1:6380</span><br><span class="line">Adding replica 127.0.0.1:6382 to 127.0.0.1:6381</span><br><span class="line">&gt;&gt;&gt; Trying to optimize slaves allocation <span class="keyword">for</span> anti-affinity</span><br><span class="line">[WARNING] Some slaves are <span class="keyword">in</span> the same host as their master</span><br><span class="line">M: 09d82a93f51a0ece0082f7ea76cd9b24d6f187fa 127.0.0.1:6379</span><br><span class="line">slots:0-5460 (5461 slots) master</span><br><span class="line">M: 784850a914cb7c815633d948548df92742286e59 127.0.0.1:6380</span><br><span class="line">slots:5461-10922 (5462 slots) master</span><br><span class="line">M: b8fad58d5b99a12e26005fffab0ac4ec398ba6d7 127.0.0.1:6381</span><br><span class="line">slots:10923-16383 (5461 slots) master</span><br><span class="line">S: 505e30fd3e2bfc2169fbe716fae91a5074098aa1 127.0.0.1:6382</span><br><span class="line">replicates b8fad58d5b99a12e26005fffab0ac4ec398ba6d7</span><br><span class="line">S: d7668819f6336df0486de69bae820901c7c745ec 127.0.0.1:6383</span><br><span class="line">replicates 09d82a93f51a0ece0082f7ea76cd9b24d6f187fa</span><br><span class="line">S: fe028a59e6c053c30b7b6d0665f16f42bbb27f6c 127.0.0.1:6384</span><br><span class="line">replicates 784850a914cb7c815633d948548df92742286e59</span><br><span class="line">Can I <span class="built_in">set</span> the above configuration? (<span class="built_in">type</span> <span class="string">'yes'</span> to accept): yes</span><br><span class="line">&gt;&gt;&gt; Nodes configuration updated</span><br><span class="line">&gt;&gt;&gt; Assign a different config epoch to each node</span><br><span class="line">&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster</span><br><span class="line">Waiting <span class="keyword">for</span> the cluster to join.....</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 127.0.0.1:6379)</span><br><span class="line">M: 09d82a93f51a0ece0082f7ea76cd9b24d6f187fa 127.0.0.1:6379</span><br><span class="line">slots:0-5460 (5461 slots) master</span><br><span class="line">1 additional replica(s)</span><br><span class="line">S: d7668819f6336df0486de69bae820901c7c745ec 127.0.0.1:6383</span><br><span class="line">slots: (0 slots) slave</span><br><span class="line">replicates 09d82a93f51a0ece0082f7ea76cd9b24d6f187fa</span><br><span class="line">M: 784850a914cb7c815633d948548df92742286e59 127.0.0.1:6380</span><br><span class="line">slots:5461-10922 (5462 slots) master</span><br><span class="line">1 additional replica(s)</span><br><span class="line">M: b8fad58d5b99a12e26005fffab0ac4ec398ba6d7 127.0.0.1:6381</span><br><span class="line">slots:10923-16383 (5461 slots) master</span><br><span class="line">1 additional replica(s)</span><br><span class="line">S: 505e30fd3e2bfc2169fbe716fae91a5074098aa1 127.0.0.1:6382</span><br><span class="line">slots: (0 slots) slave</span><br><span class="line">replicates b8fad58d5b99a12e26005fffab0ac4ec398ba6d7</span><br><span class="line">S: fe028a59e6c053c30b7b6d0665f16f42bbb27f6c 127.0.0.1:6384</span><br><span class="line">slots: (0 slots) slave</span><br><span class="line">replicates 784850a914cb7c815633d948548df92742286e59</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check <span class="keyword">for</span> open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All 16384 slots covered.</span><br><span class="line"></span><br><span class="line"><span class="comment">## 连接测试</span></span><br><span class="line">$ redis-cli -c</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> x y</span><br><span class="line">-&gt; Redirected to slot [16287] located at 127.0.0.1:6381</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6381&gt; get x</span><br><span class="line"><span class="string">"y"</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;ul&gt;
&lt;li&gt;ref:&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;a href=&quot;https://www.jianshu.com/p/d562ce7c344b&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://www.jianshu.com/p/d562ce
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>build ruby 2.2.x on centos7</title>
    <link href="https://hexo.io/news/2019/01/13/2019-01-13-build-ruby-2-2-x-on-centos7.html"/>
    <id>https://hexo.io/news/2019/01/13/2019-01-13-build-ruby-2-2-x-on-centos7.html</id>
    <published>2019-01-12T17:00:05.000Z</published>
    <updated>2019-01-12T17:02:58.000Z</updated>
    
    <content type="html"><![CDATA[<ul><li>ref: <a href="https://www.unixhot.com/article/111" target="_blank" rel="noopener">https://www.unixhot.com/article/111</a></li></ul><hr><h2 id="ruby-2-2-x-rpm-package"><a href="#ruby-2-2-x-rpm-package" class="headerlink" title="ruby 2.2.x rpm package"></a>ruby 2.2.x rpm package</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mkdir -pv rpmbuild/&#123;BUILD,BUILDROOT,RPMS,SOURCES,SPECS,SRPMS&#125;</span><br><span class="line">$ wget http://cache.ruby-lang.org/pub/ruby/2.2/ruby-2.2.9.tar.gz -P rpmbuild/SOURCES</span><br><span class="line">$ wget https://raw.githubusercontent.com/tjinjin/automate-ruby-rpm/master/ruby22x.spec -P rpmbuild/SPECS</span><br><span class="line">$ rpmbuild -bb rpmbuild/SPECS/ruby22x.spec</span><br><span class="line"><span class="comment"># yum -y localinstall rpmbuild/RPMS/x86_64/ruby-2.2.9-1.el7.centos.x86_64.rpm</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;ul&gt;
&lt;li&gt;ref: &lt;a href=&quot;https://www.unixhot.com/article/111&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://www.unixhot.com/article/111&lt;/a&gt;&lt;/li&gt;
&lt;/ul
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>centos lvm usage</title>
    <link href="https://hexo.io/news/2019/01/13/2019-01-13-centos-lvm-usage.html"/>
    <id>https://hexo.io/news/2019/01/13/2019-01-13-centos-lvm-usage.html</id>
    <published>2019-01-12T16:50:40.000Z</published>
    <updated>2019-01-12T16:59:00.000Z</updated>
    
    <content type="html"><![CDATA[<ul><li>ref: <a href="https://blog.csdn.net/u012439646/article/details/73380197" target="_blank" rel="noopener">https://blog.csdn.net/u012439646/article/details/73380197</a></li></ul><hr><h2 id="使用lvm"><a href="#使用lvm" class="headerlink" title="使用lvm"></a>使用lvm</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># fdisk -l</span></span><br><span class="line">Disk /dev/vdc: 107.4 GB, 107374182400 bytes, 209715200 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line"></span><br><span class="line"><span class="comment"># pvcreate /dev/vdc</span></span><br><span class="line">Physical volume <span class="string">"/dev/vdc"</span> successfully created.</span><br><span class="line"><span class="comment"># pvs</span></span><br><span class="line">PV VG Fmt Attr PSize PFree</span><br><span class="line">/dev/vdc lvm2 --- 100.00g 100.00g</span><br><span class="line"></span><br><span class="line"><span class="comment"># vgcreate vg0 /dev/vdc</span></span><br><span class="line">Volume group <span class="string">"vg0"</span> successfully created</span><br><span class="line"><span class="comment"># vgs</span></span><br><span class="line">VG <span class="comment">#PV #LV #SN Attr VSize VFree</span></span><br><span class="line">vg0 1 0 0 wz--n- &lt;100.00g &lt;100.00g</span><br><span class="line"></span><br><span class="line"><span class="comment"># lvcreate -n lv0 -l 100%FREE vg0</span></span><br><span class="line">Logical volume <span class="string">"lv0"</span> created.</span><br><span class="line"><span class="comment"># lvs</span></span><br><span class="line">LV VG Attr LSize Pool Origin Data% Meta% Move Log Cpy%Sync Convert</span><br><span class="line">lv0 vg0 -wi<span class="_">-a</span>----- &lt;100.00g</span><br><span class="line"></span><br><span class="line"><span class="comment"># fdisk -l</span></span><br><span class="line">Disk /dev/mapper/vg0-lv0: 107.4 GB, 107369988096 bytes, 209707008 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line"></span><br><span class="line"><span class="comment"># mkfs.xfs /dev/mapper/vg0-lv0</span></span><br><span class="line">meta-data=/dev/mapper/vg0-lv0 isize=512 agcount=4, agsize=6553344 blks</span><br><span class="line">= sectsz=512 attr=2, projid32bit=1</span><br><span class="line">= crc=1 finobt=0, sparse=0</span><br><span class="line">data = bsize=4096 blocks=26213376, imaxpct=25</span><br><span class="line">= sunit=0 swidth=0 blks</span><br><span class="line">naming =version 2 bsize=4096 ascii-ci=0 ftype=1</span><br><span class="line"><span class="built_in">log</span> =internal <span class="built_in">log</span> bsize=4096 blocks=12799, version=2</span><br><span class="line">= sectsz=512 sunit=0 blks, lazy-count=1</span><br><span class="line">realtime =none extsz=4096 blocks=0, rtextents=0</span><br><span class="line"></span><br><span class="line"><span class="comment"># mount -t xfs /dev/mapper/vg0-lv0 /program1</span></span><br><span class="line"><span class="comment"># mount</span></span><br><span class="line">/dev/mapper/vg0-lv0 on /program1 <span class="built_in">type</span> xfs (rw,relatime,attr2,inode64,noquota)</span><br></pre></td></tr></table></figure><h2 id="lvm动态扩容"><a href="#lvm动态扩容" class="headerlink" title="lvm动态扩容"></a>lvm动态扩容</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># df -h</span></span><br><span class="line">Filesystem Size Used Avail Use% Mounted on</span><br><span class="line">/dev/mapper/vg0-lv0 100G 80G 21G 80% /production</span><br><span class="line"></span><br><span class="line">- 格式化磁盘</span><br><span class="line"><span class="comment"># fdisk /dev/vdc</span></span><br><span class="line">Welcome to fdisk (util-linux 2.23.2).</span><br><span class="line">Changes will remain <span class="keyword">in</span> memory only, until you decide to write them.</span><br><span class="line">Be careful before using the write <span class="built_in">command</span>.</span><br><span class="line">Device does not contain a recognized partition table</span><br><span class="line">Building a new DOS disklabel with disk identifier 0x8198bb09.</span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): n</span><br><span class="line">Partition <span class="built_in">type</span>:</span><br><span class="line">p primary (0 primary, 0 extended, 4 free)</span><br><span class="line">e extended</span><br><span class="line">Select (default p): p</span><br><span class="line">Partition number (1-4, default 1): 1</span><br><span class="line">First sector (2048-209715199, default 2048):</span><br><span class="line">Using default value 2048</span><br><span class="line">Last sector, +sectors or +size&#123;K,M,G&#125; (2048-209715199, default 209715199):</span><br><span class="line">Using default value 209715199</span><br><span class="line">Partition 1 of <span class="built_in">type</span> Linux and of size 100 GiB is <span class="built_in">set</span></span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): wq</span><br><span class="line">The partition table has been altered!</span><br><span class="line">Calling ioctl() to re-read partition table.</span><br><span class="line">Syncing disks.</span><br><span class="line"></span><br><span class="line"><span class="comment"># fdisk -l</span></span><br><span class="line">Disk /dev/vdc: 107.4 GB, 107374182400 bytes, 209715200 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">Disk label <span class="built_in">type</span>: dos</span><br><span class="line">Disk identifier: 0x8198bb09</span><br><span class="line">Device Boot Start End Blocks Id System</span><br><span class="line">/dev/vdc1 2048 209715199 104856576 83 Linux</span><br><span class="line"></span><br><span class="line"><span class="comment"># pvcreate /dev/vdc1</span></span><br><span class="line">Physical volume <span class="string">"/dev/vdc1"</span> successfully created.</span><br><span class="line"></span><br><span class="line"><span class="comment"># vgdisplay</span></span><br><span class="line">--- Volume group ---</span><br><span class="line">VG Name vg0</span><br><span class="line">System ID</span><br><span class="line">Format lvm2</span><br><span class="line">Metadata Areas 1</span><br><span class="line">Metadata Sequence No 2</span><br><span class="line">VG Access <span class="built_in">read</span>/write</span><br><span class="line">VG Status resizable</span><br><span class="line">MAX LV 0</span><br><span class="line">Cur LV 1</span><br><span class="line">Open LV 1</span><br><span class="line">Max PV 0</span><br><span class="line">Cur PV 1</span><br><span class="line">Act PV 1</span><br><span class="line">VG Size &lt;100.00 GiB</span><br><span class="line">PE Size 4.00 MiB</span><br><span class="line">Total PE 25599</span><br><span class="line">Alloc PE / Size 25550 / 99.80 GiB</span><br><span class="line">Free PE / Size 49 / 196.00 MiB</span><br><span class="line">VG UUID IN0nD4-p7Hs-WHS1-ABGF-yv6r-NzJa-WAbNbr</span><br><span class="line"></span><br><span class="line"><span class="comment"># vgextend vg0 /dev/vdc1</span></span><br><span class="line">Volume group <span class="string">"vg0"</span> successfully extended</span><br><span class="line"></span><br><span class="line"><span class="comment"># vgdisplay</span></span><br><span class="line">--- Volume group ---</span><br><span class="line">VG Name vg0</span><br><span class="line">System ID</span><br><span class="line">Format lvm2</span><br><span class="line">Metadata Areas 2</span><br><span class="line">Metadata Sequence No 3</span><br><span class="line">VG Access <span class="built_in">read</span>/write</span><br><span class="line">VG Status resizable</span><br><span class="line">MAX LV 0</span><br><span class="line">Cur LV 1</span><br><span class="line">Open LV 1</span><br><span class="line">Max PV 0</span><br><span class="line">Cur PV 2</span><br><span class="line">Act PV 2</span><br><span class="line">VG Size 199.99 GiB</span><br><span class="line">PE Size 4.00 MiB</span><br><span class="line">Total PE 51198</span><br><span class="line">Alloc PE / Size 25550 / 99.80 GiB</span><br><span class="line">Free PE / Size 25648 / &lt;100.19 GiB</span><br><span class="line">VG UUID IN0nD4-p7Hs-WHS1-ABGF-yv6r-NzJa-WAbNbr</span><br><span class="line"></span><br><span class="line"><span class="comment"># lvdisplay</span></span><br><span class="line">--- Logical volume ---</span><br><span class="line">LV Path /dev/vg0/lv0</span><br><span class="line">LV Name lv0</span><br><span class="line">VG Name vg0</span><br><span class="line">LV UUID VPxQt7-Ryf0-scQb-u39k-AtH6-Un6i-F9nbro</span><br><span class="line">LV Write Access <span class="built_in">read</span>/write</span><br><span class="line">LV Creation host, time wiki-jira-nexus-gitlab-29-202, 2018-05-25 16:55:10 +0800</span><br><span class="line">LV Status available</span><br><span class="line"><span class="comment"># open 1</span></span><br><span class="line">LV Size 99.80 GiB</span><br><span class="line">Current LE 25550</span><br><span class="line">Segments 1</span><br><span class="line">Allocation inherit</span><br><span class="line">Read ahead sectors auto</span><br><span class="line">- currently <span class="built_in">set</span> to 256</span><br><span class="line">Block device 252:0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># lvextend -l +100%FREE /dev/vg0/lv0</span></span><br><span class="line">Size of logical volume vg0/lv0 changed from 99.80 GiB (25550 extents) to 199.99 GiB (51198 extents).</span><br><span class="line">Logical volume vg0/lv0 successfully resized.</span><br><span class="line"><span class="comment"># lvdisplay</span></span><br><span class="line">--- Logical volume ---</span><br><span class="line">LV Path /dev/vg0/lv0</span><br><span class="line">LV Name lv0</span><br><span class="line">VG Name vg0</span><br><span class="line">LV UUID VPxQt7-Ryf0-scQb-u39k-AtH6-Un6i-F9nbro</span><br><span class="line">LV Write Access <span class="built_in">read</span>/write</span><br><span class="line">LV Creation host, time wiki-jira-nexus-gitlab-29-202, 2018-05-25 16:55:10 +0800</span><br><span class="line">LV Status available</span><br><span class="line"><span class="comment"># open 1</span></span><br><span class="line">LV Size 199.99 GiB</span><br><span class="line">Current LE 51198</span><br><span class="line">Segments 2</span><br><span class="line">Allocation inherit</span><br><span class="line">Read ahead sectors auto</span><br><span class="line">- currently <span class="built_in">set</span> to 256</span><br><span class="line">Block device 252:0</span><br><span class="line"></span><br><span class="line">查看磁盘格式：</span><br><span class="line"><span class="comment"># mount</span></span><br><span class="line">/dev/mapper/vg0-lv0 on /production <span class="built_in">type</span> xfs</span><br><span class="line"></span><br><span class="line">- xfs扩容</span><br><span class="line"><span class="comment"># xfs_growfs /dev/vg0/lv0</span></span><br><span class="line">meta-data=/dev/mapper/vg0-lv0 isize=512 agcount=4, agsize=6540800 blks</span><br><span class="line">= sectsz=512 attr=2, projid32bit=1</span><br><span class="line">= crc=1 finobt=0 spinodes=0</span><br><span class="line">data = bsize=4096 blocks=26163200, imaxpct=25</span><br><span class="line">= sunit=0 swidth=0 blks</span><br><span class="line">naming =version 2 bsize=4096 ascii-ci=0 ftype=1</span><br><span class="line"><span class="built_in">log</span> =internal bsize=4096 blocks=12775, version=2</span><br><span class="line">= sectsz=512 sunit=0 blks, lazy-count=1</span><br><span class="line">realtime =none extsz=4096 blocks=0, rtextents=0</span><br><span class="line">data blocks changed from 26163200 to 52426752</span><br><span class="line"></span><br><span class="line"><span class="comment"># df -h | grep /production</span></span><br><span class="line">/dev/mapper/vg0-lv0 200G 80G 121G 40% /production</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;ul&gt;
&lt;li&gt;ref: &lt;a href=&quot;https://blog.csdn.net/u012439646/article/details/73380197&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://blog.csdn.net/u0124
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>dns and smart dns</title>
    <link href="https://hexo.io/news/2019/01/12/2019-01-12-dns-and-smart-dns.html"/>
    <id>https://hexo.io/news/2019/01/12/2019-01-12-dns-and-smart-dns.html</id>
    <published>2019-01-12T09:05:43.000Z</published>
    <updated>2019-01-12T09:08:39.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="DNS与智能DNS服务"><a href="#DNS与智能DNS服务" class="headerlink" title="DNS与智能DNS服务"></a>DNS与智能DNS服务</h1><h1 id="2-client端设定"><a href="#2-client端设定" class="headerlink" title="2. client端设定"></a>2. client端设定</h1><h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><blockquote><p>/etc/hosts<br>早期hostname对应IP的文件</p></blockquote><blockquote><p>/etc/resolv.conf<br>主机dns配置</p></blockquote><blockquote><p>/etc/nsswitch.conf<br>dns查询优先级<br><figure class="highlight plain"><figcaption><span>hosts</span><a href="/etc/nsswitch.conf">link</a></figcaption><table><tr><td class="code"><pre><span class="line">```</span><br><span class="line"></span><br><span class="line">## 查询命令</span><br><span class="line">### host</span><br><span class="line"></span><br><span class="line">### nslookup</span><br><span class="line"></span><br><span class="line">&gt; A记录：IP地址</span><br><span class="line"></span><br><span class="line">&gt; PTR：反解</span><br><span class="line"></span><br><span class="line">&gt; MX：邮件交换器</span><br><span class="line"></span><br><span class="line">&gt; NS：DNS服务器</span><br><span class="line"></span><br><span class="line">&gt; TXT：文本信息</span><br><span class="line"></span><br><span class="line">&gt; SOA：用于DNS Zone的“起始授权机构”</span><br><span class="line"></span><br><span class="line">### dig</span><br><span class="line">&gt;</span><br><span class="line">dig xxx.com @DNS-server</span><br><span class="line">&gt; 正解：</span><br><span class="line">dig [-t mx ns txt soa] xxxx.com</span><br><span class="line"></span><br><span class="line">``` bash</span><br><span class="line">[root@ldap ~]# dig 91taogu.com</span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.8.2rc1-RedHat-9.8.2-0.37.rc1.el6_7.7 &lt;&lt;&gt;&gt; 91taogu.com</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 21781</span><br><span class="line">;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0</span><br><span class="line"></span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;91taogu.com.INA</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">91taogu.com.497INA123.56.149.61</span><br><span class="line"></span><br><span class="line">;; Query time: 97 msec</span><br><span class="line">;; SERVER: 119.29.29.29#53(119.29.29.29)</span><br><span class="line">;; WHEN: Wed Apr 27 14:30:27 2016</span><br><span class="line">;; MSG SIZE  rcvd: 45</span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p>反解：<br>dig -x ip</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ldap ~]<span class="comment"># dig -x 123.56.149.61</span></span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.8.2rc1-RedHat-9.8.2-0.37.rc1.el6_7.7 &lt;&lt;&gt;&gt; -x 123.56.149.61</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NXDOMAIN, id: 37936</span><br><span class="line">;; flags: qr rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 0</span><br><span class="line"></span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;61.149.56.123.in-addr.arpa.INPTR</span><br><span class="line"></span><br><span class="line">;; AUTHORITY SECTION:</span><br><span class="line">56.123.in-addr.arpa.508INSOAhidden-master.aliyun.com. hostmaster.aliyun-inc.com. 2013090588 7200 900 2592000 600</span><br><span class="line"></span><br><span class="line">;; Query time: 7 msec</span><br><span class="line">;; SERVER: 119.29.29.29<span class="comment">#53(119.29.29.29)</span></span><br><span class="line">;; WHEN: Wed Apr 27 14:30:32 2016</span><br><span class="line">;; MSG SIZE  rcvd: 126</span><br></pre></td></tr></table></figure><h3 id="whois"><a href="#whois" class="headerlink" title="whois"></a>whois</h3><blockquote></blockquote><p>查询域名所有人</p><h1 id="3-BIND"><a href="#3-BIND" class="headerlink" title="3. BIND"></a>3. BIND</h1><h2 id="3-0-安装"><a href="#3-0-安装" class="headerlink" title="3.0 安装"></a>3.0 安装</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install bind bind-utils openssl-devel</span><br></pre></td></tr></table></figure><ul><li>或者：</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install openssl-devel openssl -y</span><br><span class="line">wget http://ftp.isc.org/isc/bind9/9.9.8/<span class="built_in">bind</span>-9.9.8.tar.gz</span><br><span class="line">tar zxf <span class="built_in">bind</span>-9.9.8.tar.gz</span><br><span class="line"><span class="built_in">cd</span> <span class="built_in">bind</span>-9.9.8</span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/named --<span class="built_in">enable</span>-threads --datadir=/usr/share --<span class="built_in">enable</span>-largefile --with-make-clean</span><br><span class="line">make -j4</span><br><span class="line">make install &amp;&amp; <span class="built_in">echo</span> $?</span><br><span class="line">groupadd named</span><br><span class="line">useradd named -g named -d /usr/<span class="built_in">local</span>/named -s /sbin/nologin</span><br><span class="line">mkdir -pv /usr/<span class="built_in">local</span>/named/</span><br><span class="line">chown -R named.named /usr/<span class="built_in">local</span>/named</span><br><span class="line">mkdir -pv /var/named</span><br><span class="line">chown -R named.named /var/named</span><br><span class="line">chown 700 /usr/<span class="built_in">local</span>/named/etc</span><br><span class="line">ln -sf /etc/rndc.conf /usr/<span class="built_in">local</span>/named/etc/rndc.conf</span><br><span class="line">ln -sf /etc/named.conf /usr/<span class="built_in">local</span>/named/etc/named.conf</span><br><span class="line"><span class="comment"># 如果rndc reload报错"ldap named[27224]: the working directory is not writable"</span></span><br><span class="line">请执行：</span><br><span class="line">chown named.root named</span><br><span class="line"><span class="comment">#Startup</span></span><br><span class="line">/usr/<span class="built_in">local</span>/named/sbin/named -c /usr/<span class="built_in">local</span>/named/etc/named.conf -u named</span><br></pre></td></tr></table></figure><h2 id="3-1-named-root生成"><a href="#3-1-named-root生成" class="headerlink" title="3.1 named.root生成"></a>3.1 named.root生成</h2><p>cd /var/named/<br>dig &gt; named.root<br>_or_<br>wget <a href="http://ftp.internic.net/domain/named.root" target="_blank" rel="noopener">http://ftp.internic.net/domain/named.root</a></p><p>## 生成rndc.conf（用于重载zonefile），并写入到named.conf（主配置文件）文件</p><ul><li><p>rndc-confgen &gt; /etc/rndc.conf<br>如果执行过程慢（由于rndc-confgen调用/dev/urandom，而/dev/urandom通过/proc/interrupts产生随机数不足，导致该命令一直等待）<br>可以指定随机数文件<br>rndc-confgen -r /dev/urandom &gt; /etc/rndc.conf</p></li><li><p>写入named.conf</p><figure class="highlight plain"><figcaption><span>-10</span><a href="/etc/rndc.conf">| head -9 | sed 's/\# //g' > /etc/named.conf```</a></figcaption><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">- 报错：</span><br><span class="line">&gt; May  3 00:52:54 cn-peking-dev-build named[19750]: the working directory is not writable</span><br><span class="line">May  3 00:52:54 cn-peking-dev-build named[19750]: managed-keys-zone: loading from master file **managed-keys.bind** failed: **permission denied**</span><br><span class="line">May  3 00:52:54 cn-peking-dev-build named[19750]: managed-keys.bind.jnl: open: permission denied</span><br><span class="line">May  3 00:52:54 cn-peking-dev-build named[19750]: managed-keys-zone: journal rollforward failed: unexpected error</span><br><span class="line">解法：</span><br><span class="line">cd /var/named</span><br><span class="line">touch managed-keys.bind</span><br><span class="line"></span><br><span class="line">## 3.2 BIND路径与chroot</span><br><span class="line">&gt; 所需文件:</span><br><span class="line"></span><br><span class="line">- /etc/named.conf</span><br><span class="line">- /var/named : 放zonefile</span><br><span class="line">- 权限named</span><br><span class="line">- zonefile : 主机名记录与IP对应</span><br><span class="line">- /var/run/named : named pid文件</span><br><span class="line"></span><br><span class="line">## 3.3 Cache-only和forwarding DNS</span><br><span class="line"></span><br><span class="line"> - Cache-only：仅有：&quot;.&quot;这个zonefile的简单dns，没有自己的dns服务器，只有缓存查询功能。</span><br><span class="line"> - Forwarding：指定上层dns服务器作为forwarding</span><br><span class="line"> - 如何设定：</span><br><span class="line">  &gt; 追加named.conf：</span><br><span class="line">    options &#123;</span><br><span class="line">        listen-on port 53 &#123; any; &#125;; # 系统默认对所有接口进行监听</span><br><span class="line">        directory        &quot;/var/named&quot;;</span><br><span class="line">        allow-query     &#123; any; &#125;; # 查询请求</span><br><span class="line">        recursion yes;</span><br><span class="line">        forward only; # 可以让dns服务器仅进行forwar，即使有.这个zonefile的设定也不会使用.的资料，只会将查询权交给上层dns</span><br><span class="line">        forwarders &#123; 114.114.114.114;119.29.29.29; &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">- rndc port 953远程控制</span><br><span class="line">&gt; rndc reload</span><br><span class="line"> </span><br><span class="line">- 抓包：</span><br><span class="line">&gt; tcpdump -K dst port 53</span><br><span class="line"></span><br><span class="line"># 4. DNS详解</span><br><span class="line">&gt; 几点注意：</span><br><span class="line"></span><br><span class="line">- DNS服务器需要在域名注册商处注册才能成为合法的DNS服务器</span><br><span class="line">- 配置文件以及目录位置</span><br><span class="line">- named主要配置文件：named.conf</span><br><span class="line">- 正反解都需要自己的zone文件，文件名由named.conf指定</span><br><span class="line">- 当dns查询时，若本身没有解析，则向root(.)或者forwarders服务器查询</span><br><span class="line">- debug：查看日志文件/var/log/messages</span><br><span class="line"></span><br><span class="line">    IN: 关键词搜索</span><br><span class="line">    RR type与RR data：</span><br><span class="line">    主机名  IN  A   IPv4</span><br><span class="line">    域名    IN  NS  nameserver</span><br><span class="line">    域名    IN  SOA 七参数</span><br><span class="line">    域名    IN  MX 数字 邮件服务器</span><br><span class="line">    主机别名    IN  CNAME   实际主机名</span><br><span class="line">    域名    IN  TXT 文本信息，以spf、_dmarc文本格式出现</span><br><span class="line"></span><br><span class="line">## 4.1.1 A、AAAA</span><br><span class="line"></span><br><span class="line">## 4.1.2 NS</span><br><span class="line">管理此域名的服务器主机名字</span><br><span class="line"></span><br><span class="line">## 4.1.3 SOA</span><br><span class="line">dig -t soa xxx.com</span><br><span class="line">管理此域名的服务器管理信息，七个重要参数</span><br><span class="line">多个DNS主机需要Master、slave，传递zonefile</span><br><span class="line"></span><br><span class="line">- Master DNS服务器主机名</span><br><span class="line">- 管理员的email（由于@在zonefile中有特殊含义，这里用.代替）</span><br><span class="line">- Serial：序列号YYMMDD00 改一次末尾数+1（Slave据此更新zonefile）</span><br><span class="line">- 刷新频率(refresh)：slave要求master更新（新版的bind中加入了notify功能，在需要的zone中加入此设定，master在更新完成某个zonefile后会主动发讯息给slave）</span><br><span class="line">- 失败重试（Retry）：如果slave因为某种原因无法从master更新数据，此时间为slave尝试重新连接master</span><br><span class="line">- 失效时间（Expire）：如果尝试一直失败，持续到达这个设定值，则不再重新连接，等待管理员处理</span><br><span class="line">- 缓存时间（TTL）： 没有在zonefile中写RR的TTL缓存时间，则以这个为准</span><br><span class="line"></span><br><span class="line">    Refresh &gt;= Retry * 2</span><br><span class="line">    Refresh + Retry &lt; Expire</span><br><span class="line">    Expire &gt;= Retry * 10</span><br><span class="line">    Expire &gt;= 7Days</span><br><span class="line">- 可以参考正规公司的值</span><br><span class="line">- aliyun vip dns&gt;&gt;: vip1.alidns.com. hostmaster.hichina.com. 2015120715 3600 1200 3600 360</span><br><span class="line"></span><br><span class="line">## 4.1.4 MX </span><br><span class="line">查询域名的邮件交换服务器主机名，数字代表优先次序，值越低表明有越高的邮件处理优先权</span><br><span class="line"></span><br><span class="line">## 4.1.5 TXT</span><br><span class="line">用来记录保存域名的附加文本信息，按照一定的格式书写，常见是spf格式，SPF用于登记某个域名拥有的用来外发邮件的所有IP地址。</span><br><span class="line">v=spf1 表示txt使用的是spf格式版本1</span><br><span class="line">include: ip4:</span><br><span class="line">~all 表示除了前面所指定的，其他IP统统不认可</span><br><span class="line"></span><br><span class="line">## 4.2 RR 反解</span><br><span class="line">PTR就是反解，查询IP对应的主机名，后面对应的是主机名，尽量使用FQDN，也就是末尾加上(.)。</span><br><span class="line">比如173.12.11.0/24，反解需要写成11.12.173.in-addr.arpa.这样的zone名称才行。</span><br><span class="line"></span><br><span class="line">## 4.3 DNS 规划</span><br><span class="line">ns1.xxx Master(NS,A)</span><br><span class="line">ns2.xxx Slave(NS,A)</span><br><span class="line"></span><br><span class="line">- 取消forwarders功能，禁止zonefile传输，</span><br><span class="line">&gt; options &#123;</span><br><span class="line">    directory &quot;/var/named&quot;;</span><br><span class="line">    pid-file &quot;named.pid&quot;;</span><br><span class="line">    forwarders &#123; 114.114.114.114; &#125;;</span><br><span class="line">    allow-query &#123; any &#125;;</span><br><span class="line">    allow-transfer &#123; none &#125;;</span><br><span class="line">&#125;;</span><br><span class="line">zone &quot;.&quot; IN &#123;</span><br><span class="line">    type hint;  # root</span><br><span class="line">    file &quot;named.root&quot;; # 已经下载</span><br><span class="line">&#125;</span><br><span class="line">zone &quot;etiantian.org&quot; IN &#123;</span><br><span class="line">    type master;</span><br><span class="line">    file &quot;etiantian.org.zone&quot;;</span><br><span class="line">    allow-update &#123; none; &#125;;</span><br><span class="line">    allow-transfer &#123; 192.168.120.209; &#125;; # slave</span><br><span class="line">    nitify yes;</span><br><span class="line">    also-notify &#123; 192.168.120.209; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line">zone &quot;120.168.192.in-addr.arpa&quot; IN &#123; #需要在运营商那里修改</span><br><span class="line">    type master;</span><br><span class="line">    file &quot;192.168.120.zone&quot;;</span><br><span class="line">    allow-transfer &#123; 192.168.120.209; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">## 4.4正解的设定</span><br><span class="line">注意：</span><br><span class="line">- 数据要从首行开始，前面不可以有空格</span><br><span class="line">- @代表zone的意思，在etiantian.org.zone中，@代表etiantian.org</span><br><span class="line">- 在192.168.120.zone中，@代表120.168.192.in-addr.arpa.</span><br><span class="line">- . 代表FQDN而不是仅有的hostname，在etiantian.org.zone中写www.etiantian.org则代表FQDN为 www.etiantian.org.@ ==&gt; www.etiantian.org.etiantian.org因此需要写成www.etiantian.org.或者www</span><br><span class="line"></span><br><span class="line">&gt; etiantian.org.zone</span><br><span class="line">$ttl 38400</span><br><span class="line">etiantian.org.  IN  SOA ns1.etiantian.org. webmaster.etiantian.org.     (</span><br><span class="line">    2016042400</span><br><span class="line">    10800</span><br><span class="line">    3600</span><br><span class="line">    604800</span><br><span class="line">    38400 )</span><br><span class="line">            IN  NS  ns1.etiantian.org.</span><br><span class="line">;            IN  NS  ns2.etiantian.org.</span><br><span class="line">ns1         IN  A   192.168.120.208</span><br><span class="line">;ns2         IN  A   192.168.120.209</span><br><span class="line">;@           IN  MX  192.168.120.209 #错误写法</span><br><span class="line">            IN  MX 10   mail</span><br><span class="line">mail        IN  A   192.168.120.209</span><br><span class="line"></span><br><span class="line">关于 .</span><br><span class="line">- 加了. 表示这是一个FQDN，即hostname + domain name，没加的话只表示domain name。</span><br><span class="line"></span><br><span class="line">## 4.5反解的设定</span><br><span class="line">反解和正解一样都需要TTL,SOA,NS，但是相对于正解，反解仅有PTR</span><br><span class="line">&gt; 192.168.120.zone</span><br><span class="line">$TTL 600</span><br><span class="line">@   IN  SOA ns1.etiantian.org. oldboy.etiantian.org. (</span><br><span class="line">    2016042400</span><br><span class="line">    1D</span><br><span class="line">    1H</span><br><span class="line">    1W</span><br><span class="line">    3H</span><br><span class="line">    )</span><br><span class="line">@   IN  NS  ns1.etiantian.org.</span><br><span class="line">208 IN  PTR ns1.etiantian.org.</span><br><span class="line">208 IN  PTR www.etiantian.org.</span><br><span class="line"></span><br><span class="line">- touch /var/named/touched_zone</span><br><span class="line">- named-checkconf /etc/named.conf</span><br><span class="line">- named-checkzone etiantian.org /var/named/etiantian.org.zone</span><br><span class="line">- named-checkzone 120.168.192.in-addr.arpa /var/named/192.168.120.zone</span><br><span class="line"></span><br><span class="line">## 4.6添加新的解析：</span><br><span class="line">- 针对要修改的zone，添加RR记录</span><br><span class="line">- 更改zonefile的serial，SOA的第三个参数</span><br><span class="line">- 重载named配置</span><br><span class="line"></span><br><span class="line"># 5 Slave DNS</span><br><span class="line">- 为了提供不间断dns服务，至少两部dns服务器供查询</span><br><span class="line">- 分散在不同的网段或者不同的机房</span><br><span class="line">- 一部master、其他为slave</span><br><span class="line">- slave本身无zonefile，其zonefile从master dns同步过来</span><br><span class="line">- 要传输的zonefile在named.conf中设定</span><br><span class="line"></span><br><span class="line">## 5.1.1 Master设定</span><br><span class="line">&gt; vim named.conf</span><br><span class="line">zone &quot;etiantian.org&quot; IN &#123;</span><br><span class="line">    type master;</span><br><span class="line">    file &quot;etiantian.org.zone&quot;;</span><br><span class="line">    **allow-transfer &#123; 192.168.120.209; &#125;;**</span><br><span class="line">&#125;;</span><br><span class="line">zone &quot;120.168.192.in-addr.arpa&quot; IN &#123;</span><br><span class="line">    type master;</span><br><span class="line">    file &quot;192.168.120.zone&quot;;</span><br><span class="line">    **allow-transfer &#123; 192.168.120.209; &#125;;**</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">## 5.1.2 在master的zonefile中添加A、NS、PTR记录（ns2）</span><br><span class="line">&gt; vim etiantian.org.zone 192.168.120.zone</span><br><span class="line">    IN  NS  ns2.etiantian.org.</span><br><span class="line">ns2 IN  A   192.168.120.209</span><br><span class="line">&lt;&lt;&lt;&lt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">209 IN  PTR ns2.etiantian.org.</span><br><span class="line"></span><br><span class="line">## 5.2 Slave设定</span><br><span class="line">&gt; vim named.conf</span><br><span class="line">zone &quot;etiantian.org&quot; IN &#123;</span><br><span class="line">    type slave;</span><br><span class="line">    file &quot;etiantian.org.zone&quot;;</span><br><span class="line">    master &#123; 192.168.120.208; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line">zone &quot;120.168.192.in-addr.arpa&quot; IN &#123;</span><br><span class="line">    type slave;</span><br><span class="line">    file &quot;192.168.120.zone&quot;;</span><br><span class="line">    master &#123; 192.168.120.208; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">## 5.3 在Master添加A记录</span><br><span class="line">&gt; vim etiantian.org.zone</span><br><span class="line">p   IN  A 192.168.120.208</span><br><span class="line">a.p   IN  A 192.168.120.208</span><br><span class="line">b.p   IN  A 192.168.120.208</span><br><span class="line">c.p   IN  A 192.168.120.208</span><br><span class="line"></span><br><span class="line">&gt; 更新RR记录，需要serial+1；更新zonefile需要rndc reload；修改named.conf需要重启named</span><br><span class="line"></span><br><span class="line"># 6 DNS View</span><br><span class="line">&gt; 视图</span><br><span class="line">根据用户来源不同而返回不同的查询结果，这个常用在cdn中，也是解决区域间带宽小和延迟大问题的解法。</span><br><span class="line"></span><br><span class="line">- 语法：</span><br><span class="line">在named.conf文件中，view配置如下：</span><br><span class="line">&gt; view &quot;internal&quot; &#123;</span><br><span class="line">&#125;;</span><br><span class="line">internal是区域名称，可自定义，需要唯一。</span><br><span class="line">区分区域通过match-clients关键字实现：</span><br><span class="line">&gt; view &quot;xxx&quot; &#123;</span><br><span class="line">    match-clients &#123; 10.0.0.0/25; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line">实现xxx视图只响应10.0.0.0/25段的请求；关键字**any**</span><br><span class="line">由于可能需要定义非常多的网段，BIND引入了**acl**关键字定义变量替换</span><br><span class="line">&gt; acl &quot;cnc&quot; &#123; 192.168.1/24;192.168.2/24; &#125;;</span><br><span class="line">view &quot;internal&quot; &#123;</span><br><span class="line">    match-clients &#123; &quot;cnc&quot;; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">- 常见：</span><br><span class="line">&gt; </span><br><span class="line">options &#123;</span><br><span class="line">&#125;;</span><br><span class="line">acl &quot;&quot; &#123;&#125;;</span><br><span class="line">view &quot;&quot; &#123;</span><br><span class="line">    match-clients &#123; &quot;&quot; &#125;;</span><br><span class="line">    zone &quot;&quot; &#123;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line">view &quot;&quot; &#123;</span><br><span class="line">    match-clients &#123; &quot;&quot; &#125;;</span><br><span class="line">    recursion no;</span><br><span class="line">    zone &quot;&quot; &#123;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">- 视图请求从上自下，如果请求的区域在上一个视图中，就不会向下一个视图请求，即使在下一个视图中放入了这个区域。</span><br><span class="line"></span><br><span class="line">- 从服务器IP配置。**因为在主服务器中划分了视图，不同来源区域被分配到不同的视图中处理，如果从服务器只有一个ip地址，从服务器就只能同步主服务器中单个视图中的zonefile。所以从服务器需要与主服务器视图数量相匹配的IP地址数量**</span><br><span class="line"></span><br><span class="line">- 默认情况下从服务器使用本地第一张网卡绑定的IP地址发送同步请求，如果不做调整，从服务器视图中仅同步第一张网卡的ip地址的主服务器视图信息。这时候我们需要在从服务器的视图中设置**transfer-source**关键字。</span><br><span class="line">&gt; transfer-source</span><br><span class="line">***transfer-source (ip4_addr | *) [port ip_port]; ]***</span><br><span class="line"></span><br><span class="line">如下是一个slave服务器视图named.conf文件：</span><br><span class="line">&gt; options &#123;</span><br><span class="line">&#125;;</span><br><span class="line">alc &quot;&quot; &#123;  &#125;;</span><br><span class="line">view &quot;&quot; &#123;</span><br><span class="line">    match-clients &#123; &quot;&quot;; &#125;;</span><br><span class="line">    **transfer-source 192.168.120.208;**</span><br><span class="line">    zone &quot;&quot; &#123;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">## 6.1 DNS View规划</span><br><span class="line">- named.conf ： 主配置文件</span><br><span class="line">&gt; include &quot;dx.cfg&quot;;</span><br><span class="line">include &quot;wt.cfg&quot;;</span><br><span class="line"></span><br><span class="line">- /var/named/dx/etiantian.org.zone</span><br><span class="line">- /var/named/wt/etiantian.org.zone</span><br><span class="line">- /var/named/others/etiantian.org.zone</span><br><span class="line"></span><br><span class="line">- /var/named/dx.cfg</span><br><span class="line">- /var/named/wt.cfg</span><br><span class="line"></span><br><span class="line">## 6.2 cfg文件</span><br><span class="line">&gt; vim dx.cfg</span><br><span class="line">acl dx &#123; ; &#125;;</span><br><span class="line">&gt; vim wt.cfg</span><br><span class="line">acl wt &#123; ; &#125;;</span><br><span class="line"></span><br><span class="line">## 6.3 Master zone配置文件</span><br><span class="line">&gt; vim wt/etiantian.org.zone</span><br><span class="line">$ttl 38400</span><br><span class="line">etiantian.org.  IN  SOA ns1.etiantian.org. webmaster.etiantian.org. (</span><br><span class="line">    2016042400</span><br><span class="line">    10800</span><br><span class="line">    3600</span><br><span class="line">    604800</span><br><span class="line">    38400)</span><br><span class="line">    IN  NS  ns1.etiantian.org.</span><br><span class="line">    IN  NS  ns2.etiantian.org.</span><br><span class="line">ns1 IN  A   192.168.120.208</span><br><span class="line">ns2 IN  A   192.168.120.209</span><br><span class="line">    IN  MX  10  mail</span><br><span class="line">www IN  A   192.168.120.20</span><br><span class="line">blog    IN  CNAME   www</span><br><span class="line">mail    IN  A   192.168.120.0</span><br><span class="line"></span><br><span class="line">## 6.4 验证</span><br><span class="line">- windows : nslookup www.etiantian.org 192.168.120.208</span><br><span class="line">- Linux : dig www.etiantian.org @192.168.120.208</span><br><span class="line"></span><br><span class="line">## 6.5 Slave</span><br><span class="line">三个view，需要三个ip去同步各个zonefile</span><br><span class="line">&gt; vim named.conf</span><br><span class="line">options &#123;</span><br><span class="line">&#125;;</span><br><span class="line">include &quot;dx.cfg&quot;;</span><br><span class="line">include &quot;wt.cfg&quot;;</span><br><span class="line">view &quot;wtzone&quot; &#123;</span><br><span class="line">    match-clients &#123; wt; 10.0.0.8; !10.0.0.9; !10.0.0.10; &#125;;</span><br><span class="line">    **transfer-source 10.0.0.8; # Master &gt;&gt; allow-transfer &#123; 10.0.0.8; &#125;;</span><br><span class="line">    allow-notify &#123; 10.0.0.8; &#125;;** # Master &gt;&gt; also-notify &#123; 10.0.0.8; &#125;;</span><br><span class="line">    recursion yes;</span><br><span class="line">zone &quot;.&quot; IN &#123;</span><br><span class="line">    type hint;</span><br><span class="line">    file &quot;named.root&quot;;</span><br><span class="line">&#125;;</span><br><span class="line">zone &quot;etiantian.org&quot; IN &#123;</span><br><span class="line">    type slave;</span><br><span class="line">    file &quot;wt/etiantian.org.zone&quot;;</span><br><span class="line">    masters &#123;  10.0.0.7; &#125;;         ## &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; Master</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line">view &quot;dxzone&quot; &#123;</span><br><span class="line">    match-clients &#123; wt; !10.0.0.8; 10.0.0.9; !10.0.0.10; &#125;;</span><br><span class="line">    **transfer-source 10.0.0.9;   # Master &gt;&gt; allow-transfer &#123; 10.0.0.9; &#125;;</span><br><span class="line">    allow-notify &#123; 10.0.0.9; &#125;; # Master &gt;&gt; also-notify &#123; 10.0.0.9; &#125;;**</span><br><span class="line">    recursion yes;</span><br><span class="line">zone &quot;.&quot; IN &#123;</span><br><span class="line">    type hint;</span><br><span class="line">    file &quot;named.root&quot;;</span><br><span class="line">&#125;;</span><br><span class="line">zone &quot;etiantian.org&quot; IN &#123;</span><br><span class="line">    type slave;</span><br><span class="line">    file &quot;dx/etiantian.org.zone&quot;;</span><br><span class="line">    masters &#123;  10.0.0.7; &#125;;         ## &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; Master</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line">view &quot;otherszone&quot; &#123;</span><br><span class="line">    match-clients &#123; any; !10.0.0.8; !10.0.0.9; 10.0.0.10; &#125;;</span><br><span class="line">    **transfer-source 10.0.0.10; # Master &gt;&gt; allow-transfer &#123; 10.0.0.10; &#125;;</span><br><span class="line">    allow-notify &#123; 10.0.0.10; &#125;; # Master &gt;&gt; also-notify &#123; 10.0.0.10; &#125;;**</span><br><span class="line">    recursion yes;</span><br><span class="line">zone &quot;etiantian.org&quot; IN &#123;</span><br><span class="line">    type slave;</span><br><span class="line">    file &quot;others/etiantian.org.zone&quot;;</span><br><span class="line">    masters &#123;  10.0.0.7; &#125;;         ## &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; Master</span><br><span class="line">&#125;;    </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&gt; 配置ip地址</span><br><span class="line"></span><br><span class="line">``` cp -ap ifconfig-eth1 ifconfig-eth1:0</span><br></pre></td></tr></table></figure></li></ul><figure class="highlight plain"><figcaption><span>-ap ifconfig-eth1 ifconfig-eth1:1```</span></figcaption><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>DEVICE=eth1:0<br>BOOTPROTO=none<br>ONBOOT=yes<br>IPV6INIT=no<br>IPADDR=10.0.0.9<br><code>`</code></p><ul><li>ifconfig eth0:0 10.0.0.9 netmask 24</li><li>ifconfig eth0:1 10.0.0.10 netmask 24</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;DNS与智能DNS服务&quot;&gt;&lt;a href=&quot;#DNS与智能DNS服务&quot; class=&quot;headerlink&quot; title=&quot;DNS与智能DNS服务&quot;&gt;&lt;/a&gt;DNS与智能DNS服务&lt;/h1&gt;&lt;h1 id=&quot;2-client端设定&quot;&gt;&lt;a href=&quot;#2-clie
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Build openvpn</title>
    <link href="https://hexo.io/news/2019/01/12/2019-01-12-Build-openvpn.html"/>
    <id>https://hexo.io/news/2019/01/12/2019-01-12-Build-openvpn.html</id>
    <published>2019-01-12T08:32:15.000Z</published>
    <updated>2019-01-13T12:48:42.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="openvpn搭建"><a href="#openvpn搭建" class="headerlink" title="openvpn搭建"></a>openvpn搭建</h1><h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><ul><li><strong>外出人员访问内部资源：ERP，OA，文件共享，wiki。</strong></li><li><strong>运维访问IDC机房</strong></li></ul><h2 id="协议说明"><a href="#协议说明" class="headerlink" title="协议说明"></a>协议说明</h2><blockquote></blockquote><pre><code>L2TP：PPTP的后续版本，两个端点之间的单一隧道，支持隧道验证，没有与生俱来的加密和保密支持，通常需要和IPSEC配合使用。SSL VPN：使用TLSv1、SSLv3，不是一个基于web的软件，不与ipsec及其他的VPN软件兼容，C/S架构，单独使用openVPN客户端。对于认证，OpenVPN提供了两种认证方法：基于用户名/密码的认证与SSL证书认证。适合外出移动或家庭办公用户考虑使用。IPSEC：适合于企业异地总分公司或多个IDC机房间不间断按需连接。ipsec VPN的开源实现openswan</code></pre><h2 id="使用方案建议："><a href="#使用方案建议：" class="headerlink" title="使用方案建议："></a>使用方案建议：</h2><pre><code>1、不差钱，可以选择硬件产品2、互联网公司、开源、省钱3、个人：拨号选择openVPN；不希望使用拨号客户端，则选择pptp；多个企业间或IDC机房互联，选择ipsecVPN或者openVPN</code></pre><p>基于一个单一的IP端口，默认1194，默认使用udp协议通讯，建议使用TCP协议工作。</p><p>tcpdump<br>route</p><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><h3 id="安装基础"><a href="#安装基础" class="headerlink" title="安装基础"></a>安装基础</h3><blockquote><p>YUM安装</p></blockquote><hr><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum install openssl openssl-devel openvpn openvpn-auth-ldap lzo -y</span></span><br><span class="line"></span><br><span class="line">========================================================================================================================</span><br><span class="line"> Package                           Arch                   Version                            Repository            Size</span><br><span class="line">========================================================================================================================</span><br><span class="line">Installing:</span><br><span class="line"> lzo                               x86_64                 2.03-3.1.el6_5.1                   base                  55 k</span><br><span class="line"> openvpn                           x86_64                 2.3.14-1.el6                       epel                 424 k</span><br><span class="line"> openvpn-auth-ldap                 x86_64                 2.0.3-6.el6                        epel                  42 k</span><br><span class="line">Installing <span class="keyword">for</span> dependencies:</span><br><span class="line"> libobjc                           x86_64                 4.4.7-17.el6                       base                  92 k</span><br><span class="line"> pkcs11-helper                     x86_64                 1.11-3.el6                         epel                  54 k</span><br></pre></td></tr></table></figure><hr><blockquote><p>自编译安装</p></blockquote><ul><li><p>安装依赖【推荐】</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install -y lzo lzo-devel openssl openssl-devel pam pam-devel rpm-build</span><br><span class="line">yum install -y pkcs11-helper pkcs11-helper-devel</span><br></pre></td></tr></table></figure></li><li><p>下载安装压缩库【可选】</p></li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget http://www.oberhumer.com/opensource/lzo/download/lzo-2.06.tar.gz</span><br><span class="line">tar zxf lzo-2.06.tar.gz</span><br><span class="line"><span class="built_in">cd</span> lzo-2.06</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">make install clean</span><br><span class="line"><span class="built_in">cd</span> ..</span><br></pre></td></tr></table></figure><ul><li>下载安装openvpn</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget http://swupdate.openvpn.org/community/releases/openvpn-2.2.2.tar.gz</span><br><span class="line">rm -rf openvpn-2.2.2 &amp;&amp; tar zxf openvpn-2.2.2.tar.gz</span><br><span class="line"><span class="built_in">cd</span> openvpn-2.2.2</span><br><span class="line">./configure --with-lzo-headers=/usr/<span class="built_in">local</span>/include --with-lzo-lib=/usr/<span class="built_in">local</span>/lib</span><br><span class="line">make -j4</span><br><span class="line">make install</span><br></pre></td></tr></table></figure><p><em>Tips</em></p><blockquote><p>make: *** No targets specified and no makefile found.  Stop.<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum reinstall openssl* -y</span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p>如果发现yum install安装也不行，需要执行<code>yum reinstall</code></p></blockquote><p><em>查看安装结果</em><br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># which openvpn</span></span><br><span class="line">/usr/<span class="built_in">local</span>/sbin/openvpn</span><br></pre></td></tr></table></figure></p><h3 id="配置openvpn-server，并建立CA证书"><a href="#配置openvpn-server，并建立CA证书" class="headerlink" title="配置openvpn server，并建立CA证书"></a>配置openvpn server，并建立CA证书</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src</span><br><span class="line"><span class="built_in">cd</span> openvpn-2.2.2/easy-rsa/2.0</span><br><span class="line">cp -ap vars&#123;,.orig&#125;</span><br><span class="line">ls -la vars*</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># vim vars</span><br><span class="line">&gt;  # modify by lang</span><br><span class="line">export KEY_COUNTRY=&quot;CN&quot;</span><br><span class="line">export KEY_PROVINCE=&quot;BJ&quot;</span><br><span class="line">export KEY_CITY=&quot;Beijing&quot;</span><br><span class="line">export KEY_ORG=&quot;oldboy&quot;</span><br><span class="line">export KEY_EMAIL=&quot;example@qq.com&quot;</span><br><span class="line">export KEY_EMAIL=example@qq.com</span><br><span class="line">export KEY_CN=company</span><br><span class="line">export KEY_NAME=company</span><br><span class="line">export KEY_OU=company</span><br><span class="line">export PKCS11_MODULE_PATH=changeme</span><br><span class="line">export PKCS11_PIN=1234</span><br><span class="line"># modify by lang</span><br><span class="line"></span><br><span class="line"># source vars</span><br><span class="line"># ./clean-all</span><br><span class="line"># ./build-ca</span><br><span class="line"></span><br><span class="line">Generating a 1024 bit RSA private key</span><br><span class="line">............++++++</span><br><span class="line">........................................++++++</span><br><span class="line">writing new private key to &apos;ca.key&apos;</span><br><span class="line">-----</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter &apos;.&apos;, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [CN]:</span><br><span class="line">State or Province Name (full name) [BJ]:</span><br><span class="line">Locality Name (eg, city) [Beijing]:</span><br><span class="line">Organization Name (eg, company) [oldboy]:company</span><br><span class="line">Organizational Unit Name (eg, section) [company]:</span><br><span class="line">Common Name (eg, your name or your server&apos;s hostname) [company]:</span><br><span class="line">Name [company]:</span><br><span class="line">Email Address [example@qq.com]:</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ll keys/</span><br><span class="line">&gt; total 12</span><br><span class="line">-rw-r--r-- 1 root root 1330 Jul 18 21:01 ca.crt &lt;-证书</span><br><span class="line">-rw------- 1 root root  920 Jul 18 21:01 ca.key &lt;-RSA key</span><br><span class="line">-rw-r--r-- 1 root root    0 Jul 18 21:00 index.txt</span><br><span class="line">-rw-r--r-- 1 root root    3 Jul 18 21:00 serial</span><br></pre></td></tr></table></figure><h3 id="生成vpn服务器端证书和密钥文件"><a href="#生成vpn服务器端证书和密钥文件" class="headerlink" title="生成vpn服务器端证书和密钥文件"></a>生成vpn服务器端证书和密钥文件</h3><ul><li><p>[x] ./build-key-server server</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Generating a 1024 bit RSA private key</span><br><span class="line">....++++++</span><br><span class="line">..........++++++</span><br><span class="line">writing new private key to <span class="string">'server.key'</span></span><br><span class="line">-----</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter <span class="string">'.'</span>, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [CN]:</span><br><span class="line">State or Province Name (full name) [BJ]:</span><br><span class="line">Locality Name (eg, city) [Beijing]:</span><br><span class="line">Organization Name (eg, company) [oldboy]:company</span><br><span class="line">Organizational Unit Name (eg, section) [company]:</span><br><span class="line">Common Name (eg, your name or your server<span class="string">'s hostname) [server]:</span></span><br><span class="line"><span class="string">Name [company]:</span></span><br><span class="line"><span class="string">Email Address [example@qq.com]:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Please enter the following '</span>extra<span class="string">' attributes</span></span><br><span class="line"><span class="string">to be sent with your certificate request</span></span><br><span class="line"><span class="string">A challenge password []:1234Qwer</span></span><br><span class="line"><span class="string">An optional company name []:company</span></span><br><span class="line"><span class="string">Using configuration from /usr/local/src/openvpn-2.2.2/easy-rsa/2.0/openssl-1.0.0.cnf</span></span><br><span class="line"><span class="string">Check that the request matches the signature</span></span><br><span class="line"><span class="string">Signature ok</span></span><br><span class="line"><span class="string">The Subject'</span>s Distinguished Name is as follows</span><br><span class="line">countryName           :PRINTABLE:<span class="string">'CN'</span></span><br><span class="line">stateOrProvinceName   :PRINTABLE:<span class="string">'BJ'</span></span><br><span class="line">localityName          :PRINTABLE:<span class="string">'Beijing'</span></span><br><span class="line">organizationName      :PRINTABLE:<span class="string">'company'</span></span><br><span class="line">organizationalUnitName:PRINTABLE:<span class="string">'company'</span></span><br><span class="line">commonName            :PRINTABLE:<span class="string">'server'</span></span><br><span class="line">name                  :PRINTABLE:<span class="string">'company'</span></span><br><span class="line">emailAddress          :IA5STRING:<span class="string">'example@qq.com'</span></span><br><span class="line">Certificate is to be certified until Jul 15 13:15:47 2025 GMT (3650 days)</span><br><span class="line">Sign the certificate? [y/n]:y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1 out of 1 certificate requests certified, commit? [y/n]y</span><br><span class="line">Write out database with 1 new entries</span><br><span class="line">Data Base Updated</span><br></pre></td></tr></table></figure></li><li><p>[x] 检测结果</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ll keys/</span><br><span class="line">total 40</span><br><span class="line">-rw-r--r-- 1 root root 4029 Jul 18 21:15 01.pem</span><br><span class="line">-rw-r--r-- 1 root root 1330 Jul 18 21:01 ca.crt</span><br><span class="line">-rw------- 1 root root  920 Jul 18 21:01 ca.key</span><br><span class="line">-rw-r--r-- 1 root root  124 Jul 18 21:15 index.txt</span><br><span class="line">-rw-r--r-- 1 root root   21 Jul 18 21:15 index.txt.attr</span><br><span class="line">-rw-r--r-- 1 root root    0 Jul 18 21:00 index.txt.old</span><br><span class="line">-rw-r--r-- 1 root root    3 Jul 18 21:15 serial</span><br><span class="line">-rw-r--r-- 1 root root    3 Jul 18 21:00 serial.old</span><br><span class="line">-rw-r--r-- 1 root root 4029 Jul 18 21:15 server.crt</span><br><span class="line">-rw-r--r-- 1 root root  777 Jul 18 21:15 server.csr</span><br><span class="line">-rw------- 1 root root  916 Jul 18 21:15 server.key</span><br></pre></td></tr></table></figure></li></ul><h3 id="生成vpn客户端证书和密钥文件方案"><a href="#生成vpn客户端证书和密钥文件方案" class="headerlink" title="生成vpn客户端证书和密钥文件方案"></a>生成vpn客户端证书和密钥文件方案</h3><ul><li><p>[x] 无密码</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ./build-key test</span></span><br><span class="line">Generating a 1024 bit RSA private key</span><br><span class="line">.........................................................++++++</span><br><span class="line">.......++++++</span><br><span class="line">writing new private key to <span class="string">'test.key'</span></span><br><span class="line">-----</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter <span class="string">'.'</span>, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [CN]:</span><br><span class="line">State or Province Name (full name) [BJ]:</span><br><span class="line">Locality Name (eg, city) [Beijing]:</span><br><span class="line">Organization Name (eg, company) [oldboy]:company</span><br><span class="line">Organizational Unit Name (eg, section) [company]:</span><br><span class="line">Common Name (eg, your name or your server<span class="string">'s hostname) [test]:</span></span><br><span class="line"><span class="string">Name [company]:</span></span><br><span class="line"><span class="string">Email Address [example@qq.com]:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Please enter the following '</span>extra<span class="string">' attributes</span></span><br><span class="line"><span class="string">to be sent with your certificate request</span></span><br><span class="line"><span class="string">A challenge password []:1234Qwer</span></span><br><span class="line"><span class="string">An optional company name []:</span></span><br><span class="line"><span class="string">Using configuration from /usr/local/src/openvpn-2.2.2/easy-rsa/2.0/openssl-1.0.0.cnf</span></span><br><span class="line"><span class="string">Check that the request matches the signature</span></span><br><span class="line"><span class="string">Signature ok</span></span><br><span class="line"><span class="string">The Subject'</span>s Distinguished Name is as follows</span><br><span class="line">countryName           :PRINTABLE:<span class="string">'CN'</span></span><br><span class="line">stateOrProvinceName   :PRINTABLE:<span class="string">'BJ'</span></span><br><span class="line">localityName          :PRINTABLE:<span class="string">'Beijing'</span></span><br><span class="line">organizationName      :PRINTABLE:<span class="string">'company'</span></span><br><span class="line">organizationalUnitName:PRINTABLE:<span class="string">'company'</span></span><br><span class="line">commonName            :PRINTABLE:<span class="string">'test'</span></span><br><span class="line">name                  :PRINTABLE:<span class="string">'company'</span></span><br><span class="line">emailAddress          :IA5STRING:<span class="string">'example@qq.com'</span></span><br><span class="line">Certificate is to be certified until Jul 15 13:23:41 2025 GMT (3650 days)</span><br><span class="line">Sign the certificate? [y/n]:y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1 out of 1 certificate requests certified, commit? [y/n]y</span><br><span class="line">Write out database with 1 new entries</span><br><span class="line">Data Base Updated</span><br></pre></td></tr></table></figure></li><li><p>[x] 带密码</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./build-key-pass ett</span><br><span class="line">Generating a 1024 bit RSA private key</span><br><span class="line">....................................++++++</span><br><span class="line">.++++++</span><br><span class="line">writing new private key to <span class="string">'ett.key'</span></span><br><span class="line">Enter PEM pass phrase: &lt;-1234Qwer</span><br><span class="line">Verifying - Enter PEM pass phrase:</span><br><span class="line">-----</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter <span class="string">'.'</span>, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [CN]:</span><br><span class="line">State or Province Name (full name) [BJ]:</span><br><span class="line">Locality Name (eg, city) [Beijing]:</span><br><span class="line">Organization Name (eg, company) [oldboy]:company</span><br><span class="line">Organizational Unit Name (eg, section) [company]:</span><br><span class="line">Common Name (eg, your name or your server<span class="string">'s hostname) [ett]:</span></span><br><span class="line"><span class="string">Name [company]:</span></span><br><span class="line"><span class="string">Email Address [example@qq.com]:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Please enter the following '</span>extra<span class="string">' attributes</span></span><br><span class="line"><span class="string">to be sent with your certificate request</span></span><br><span class="line"><span class="string">A challenge password []:1234Qwer</span></span><br><span class="line"><span class="string">An optional company name []:</span></span><br><span class="line"><span class="string">Using configuration from /usr/local/src/openvpn-2.2.2/easy-rsa/2.0/openssl-1.0.0.cnf</span></span><br><span class="line"><span class="string">Check that the request matches the signature</span></span><br><span class="line"><span class="string">Signature ok</span></span><br><span class="line"><span class="string">The Subject'</span>s Distinguished Name is as follows</span><br><span class="line">countryName           :PRINTABLE:<span class="string">'CN'</span></span><br><span class="line">stateOrProvinceName   :PRINTABLE:<span class="string">'BJ'</span></span><br><span class="line">localityName          :PRINTABLE:<span class="string">'Beijing'</span></span><br><span class="line">organizationName      :PRINTABLE:<span class="string">'company'</span></span><br><span class="line">organizationalUnitName:PRINTABLE:<span class="string">'company'</span></span><br><span class="line">commonName            :PRINTABLE:<span class="string">'ett'</span></span><br><span class="line">name                  :PRINTABLE:<span class="string">'company'</span></span><br><span class="line">emailAddress          :IA5STRING:<span class="string">'example@qq.com'</span></span><br><span class="line">Certificate is to be certified until Jul 15 13:26:38 2025 GMT (3650 days)</span><br><span class="line">Sign the certificate? [y/n]:y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1 out of 1 certificate requests certified, commit? [y/n]y</span><br><span class="line">Write out database with 1 new entries</span><br><span class="line">Data Base Updated</span><br></pre></td></tr></table></figure></li></ul><h3 id="生成vpn密钥协议交换文件"><a href="#生成vpn密钥协议交换文件" class="headerlink" title="生成vpn密钥协议交换文件"></a>生成vpn密钥协议交换文件</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./build-dh</span><br></pre></td></tr></table></figure><blockquote><p>生成结果：<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ll keys/dh1024.pem</span><br><span class="line">-rw-r--r-- 1 root root 245 Jul 18 21:29 keys/dh1024.pem</span><br></pre></td></tr></table></figure></p></blockquote><h3 id="详解服务器及客户端的证书各文件用途"><a href="#详解服务器及客户端的证书各文件用途" class="headerlink" title="详解服务器及客户端的证书各文件用途"></a>详解服务器及客户端的证书各文件用途</h3><blockquote><p>| 文件名 | 被依赖 | 目的 | 保密 |<br>ca.cert | server+all clts | RootCACert | NO<br>ca.key key | signing mach only | RootCAkey | YES<br>dh{n}.pem | server only | DH parameters | NO<br>server.crt | server only | Svr Cert | NO<br>server.key | server only | Svr key | Yes</p></blockquote><p>test.crt | test only | clt Cert | NO<br>test.key | test only | clt key | YES<br>ett.crt | ett only | ett Cert | NO<br>ett.key | ett only | ett key | YES</p><h4 id="生成防止恶意攻击文件"><a href="#生成防止恶意攻击文件" class="headerlink" title="生成防止恶意攻击文件"></a>生成防止恶意攻击文件</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">openvpn --genkey --secret keys/ta.key</span><br><span class="line">ll keys/ta.key</span><br></pre></td></tr></table></figure><h4 id="重要命令说明"><a href="#重要命令说明" class="headerlink" title="重要命令说明"></a>重要命令说明</h4><blockquote><ul><li>vars 用来创建环境变量，设置所有需要的变量脚本</li><li>clean-all 清除文件及目录</li><li>build-ca 脚本生成ca证书</li><li>build-dh 脚本生成dh文件</li><li>buid-key-server 生成服务器端密钥</li><li>build-key 生成客户端密钥</li><li>build-key-pass 带密码</li><li>pkitool 脚本直接使用vars环境变量设置，直接生成证书（非交互）</li></ul></blockquote><h4 id="详解openvpn服务端重要配置参数并实践"><a href="#详解openvpn服务端重要配置参数并实践" class="headerlink" title="详解openvpn服务端重要配置参数并实践"></a>详解openvpn服务端重要配置参数并实践</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkdir -p /etc/openvpn</span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src/openvpn-2.2.2/easy-rsa/2.0</span><br><span class="line">cp -ap keys /etc/openvpn</span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src/openvpn-2.2.2/sample-config-files</span><br><span class="line">cp -afv client.conf server.conf /etc/openvpn/</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">tree /etc/openvpn/</span><br><span class="line">/etc/openvpn/</span><br><span class="line">├── 01.pem</span><br><span class="line">├── 02.pem</span><br><span class="line">├── 03.pem</span><br><span class="line">├── ca.crt</span><br><span class="line">├── ca.key</span><br><span class="line">├── client.conf</span><br><span class="line">├── dh1024.pem</span><br><span class="line">├── ett.crt</span><br><span class="line">├── ett.csr</span><br><span class="line">├── ett.key</span><br><span class="line">├── index.txt</span><br><span class="line">├── index.txt.attr</span><br><span class="line">├── index.txt.attr.old</span><br><span class="line">├── index.txt.old</span><br><span class="line">├── serial</span><br><span class="line">├── serial.old</span><br><span class="line">├── server.conf</span><br><span class="line">├── server.crt</span><br><span class="line">├── server.csr</span><br><span class="line">├── server.key</span><br><span class="line">├── ta.key</span><br><span class="line">├── test.crt</span><br><span class="line">├── test.csr</span><br><span class="line">└── test.key</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/openvpn/</span><br><span class="line">cp -ap server.conf&#123;,.orig&#125;</span><br><span class="line">grep -vE <span class="string">";|#|^$"</span> server.conf</span><br><span class="line"></span><br><span class="line">port 1194</span><br><span class="line">proto udp</span><br><span class="line">dev tun</span><br><span class="line">ca ca.crt</span><br><span class="line">cert server.crt</span><br><span class="line">dh dh1024.pem</span><br><span class="line">server 10.8.0.0 255.255.255.0</span><br><span class="line">ifconfig-pool-persist ipp.txt</span><br><span class="line">keepalive 10 120</span><br><span class="line">comp-lzo</span><br><span class="line">persist-key</span><br><span class="line">persist-tun</span><br><span class="line">status openvpn-status.log</span><br><span class="line">verb 3</span><br></pre></td></tr></table></figure><h4 id="server-conf配置案例"><a href="#server-conf配置案例" class="headerlink" title="server.conf配置案例"></a>server.conf配置案例</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">local 10.0.0.28 openvpn监听的外网地址10.0.0.28:1194</span><br><span class="line"></span><br><span class="line">port 52115      监听的端口，默认是1194，为了安全起见修改为52115</span><br><span class="line"></span><br><span class="line">proto udp       并发多时，选择tcp</span><br><span class="line"></span><br><span class="line">dev tun         vpn server采用的路由模式，可以选tap或者tun</span><br><span class="line"></span><br><span class="line">ca ca.cert      ca证书，此文件需要和server.conf在一个目录下，否则需要绝对路径调用</span><br><span class="line"></span><br><span class="line">cert server.cert</span><br><span class="line">key server.key  &lt;====重要</span><br><span class="line">dh dh1024.pem</span><br><span class="line"></span><br><span class="line">server 10.8.0.0 255.255.255.0 这个是VPN server动态分配给VPN client的地址池，一般不需要更改，这个段不要和现网冲突</span><br><span class="line"></span><br><span class="line">ifconfig-pool-persist ipp.txt</span><br><span class="line"></span><br><span class="line">push &quot;route 172.16.1.0 255.255.255.0&quot; 这是VPN server所在的内网网段，如果有多个网段可以写多个push，此命令实际作用是在VPN客户端本地生成。</span><br></pre></td></tr></table></figure><blockquote><p>如果想知道VPN到底在本地加了哪些路由，可以在拨号前笔记本记下所有路由的条目，然后使用软件比较变化即可。</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">client-to-client 允许拨号的多个client互相通讯</span><br><span class="line"></span><br><span class="line">duplicate-cn    允许多个客户端使用同一账号连接 &lt;== 多人共享账号</span><br><span class="line"></span><br><span class="line">keepalive 10 120 每10秒ping一次，若120s未收到包，即认为客户端断开</span><br><span class="line"></span><br><span class="line">comp-lzo    开启压缩功能</span><br><span class="line"></span><br><span class="line">persist-key 当VPN超时后，重启VPN后，保持上一次使用的私钥，而不重新读取私钥</span><br><span class="line"></span><br><span class="line">persist=tun 通过keepalive检测VPN超时后，当重新启动VPN后，保持tun或者tap设备自动连接状态</span><br><span class="line"></span><br><span class="line">status openvpn-status.log openvpn日志状态信息</span><br><span class="line"></span><br><span class="line"><span class="built_in">log</span> /var/<span class="built_in">log</span>/openvpn.log    日志文件</span><br><span class="line"></span><br><span class="line">verb 3      指定日志文件冗余</span><br></pre></td></tr></table></figure><p><em>Tips</em></p><blockquote><p>先执行export LANG=”ZH_GB18030”，然后编辑配置文件server.conf，清空所有内容，拷贝上面内容，然后执行 <em>dos2unix server.conf</em></p></blockquote><h4 id="实际服务器端VPN配置文件server-conf配置"><a href="#实际服务器端VPN配置文件server-conf配置" class="headerlink" title="实际服务器端VPN配置文件server.conf配置"></a>实际服务器端VPN配置文件server.conf配置</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">local</span> 124.43.12.115</span><br><span class="line">port 52115</span><br><span class="line">proto tcp</span><br><span class="line">dev tun</span><br><span class="line"></span><br><span class="line">ca /etc/openvpn/keys/ca.crt</span><br><span class="line">cert /etc/openvpn/keys/server.crt</span><br><span class="line">key /etc/openvpn/keys/server.key</span><br><span class="line">dh /etc/openvpn/keys/dh1024.pem</span><br><span class="line"></span><br><span class="line">server 10.8.0.0 255.255.255.0</span><br><span class="line">push <span class="string">"route 10.0.0.0 255.255.255.0"</span></span><br><span class="line">ifconfig-pool-persist ipp.txt</span><br><span class="line">keepalive 10 120</span><br><span class="line">comp-lzo</span><br><span class="line">persist-key</span><br><span class="line">persist-tun</span><br><span class="line">status openvpn-status.log</span><br><span class="line">verb 3</span><br><span class="line"></span><br><span class="line">client-to-client</span><br><span class="line">duplicate-cn</span><br><span class="line"><span class="built_in">log</span> /var/<span class="built_in">log</span>/openvpn.log</span><br></pre></td></tr></table></figure><blockquote><p>cp -ap server.conf{,.orig}<br>grep -vE “;|#|^$” server.conf &gt; tmp.log<br>mv tmp.log server.conf</p></blockquote><h4 id="配置调试vpn并准备运行vpn服务"><a href="#配置调试vpn并准备运行vpn服务" class="headerlink" title="配置调试vpn并准备运行vpn服务"></a>配置调试vpn并准备运行vpn服务</h4><blockquote><ul><li>取消服务器防火墙对openvpn（默认1194，本例52115）的拦截。并允许服务进行转发<br>iptables -A INPUT -p tcp –dport 52115 -j ACCEPT<br>iptables -L -n<br>vim /etc/sysconfig/iptables</li></ul></blockquote><p><em>先关闭IPtables</em></p><ul><li>selinux</li><li>开启内核转发（路由）：<br>ip_forward = 1</li></ul><h4 id="启动服务器端VPN"><a href="#启动服务器端VPN" class="headerlink" title="启动服务器端VPN"></a>启动服务器端VPN</h4><p>/usr/local/sbin/openvpn –config /etc/openvpn/server.conf &amp;</p><p>无意外服务开启后，会出现 tun0网卡；<br>意外的日志：<br>/var/log/openvpn.log</p><blockquote><p>tail -f /var/log/openvpn.log<br>Sat Oct 24 18:06:41 2015 OpenVPN 2.2.2 x86_64-unknown-linux-gnu [SSL] [LZO2] [EPOLL] [eurephia] built on Jul 18 2015<br>Sat Oct 24 18:06:41 2015 NOTE: OpenVPN 2.1 requires ‘–script-security 2’ or higher to call user-defined scripts or executables<br>Sat Oct 24 18:06:41 2015 Diffie-Hellman initialized with 1024 bit key<br>Sat Oct 24 18:06:41 2015 TLS-Auth MTU parms [ L:1542 D:138 EF:38 EB:0 ET:0 EL:0 ]<br>Sat Oct 24 18:06:41 2015 Socket Buffers: R=[8388608-&gt;131072] S=[8388608-&gt;131072]<br>Sat Oct 24 18:06:41 2015 TCP/UDP: Socket bind failed on local address 59.108.85.71:52115: Cannot assign requested address<br>Sat Oct 24 18:06:41 2015 Exiting</p></blockquote><blockquote><p>ip addr<br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>2: em1: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN qlen 1000<br>    link/ether b8:2a:72:da:82:a4 brd ff:ff:ff:ff:ff:ff<br>3: em2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP qlen 1000<br>    link/ether b8:2a:72:da:82:a5 brd ff:ff:ff:ff:ff:ff<br>    inet 192.168.20.11/24 brd 192.168.20.255 scope global em2<br>4: em3: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN qlen 1000<br>    link/ether b8:2a:72:da:82:a6 brd ff:ff:ff:ff:ff:ff<br>5: em4: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN qlen 1000<br>    link/ether b8:2a:72:da:82:a7 brd ff:ff:ff:ff:ff:ff<br>6: tun0: &lt;POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UNKNOWN qlen 100<br>    link/[65534]<br>    inet 10.8.0.1 peer 10.8.0.2/32 scope global tun0</p></blockquote><ul><li><p>开机加载<br>echo ‘/usr/local/sbin/openvpn –config /etc/openvpn/server.conf &amp;’ &gt;&gt; /etc/rc.local</p></li><li><p>自带启动脚本：</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">/usr/local/sbin/openvpn --daemon --writepid /var/run/openvpn/server/pid --config server.conf --cd /etc/openvpn</span><br></pre></td></tr></table></figure></li></ul><h4 id="规范启动openvpn"><a href="#规范启动openvpn" class="headerlink" title="规范启动openvpn"></a>规范启动openvpn</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd /usr/local/src/openvpn-2.2.2/sample-scripts</span><br><span class="line">cp openvpn.init /etc/init.d/openvpn</span><br><span class="line">chmod 700 /etc/init.d/openvpn</span><br><span class="line">chkconfig --add openvpn</span><br></pre></td></tr></table></figure><p>如果/etc/openvpn下conf文件过多，导致无法启动，请尝试修改/etc/init.d/openvpn：</p><blockquote><p>service openvpn restart<br>Shutting down openvpn:                                     [  OK  ]<br>Starting openvpn:                                          [FAILED]<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ls *.conf</span><br><span class="line">--&gt;</span><br><span class="line">ls server.conf</span><br></pre></td></tr></table></figure></p></blockquote><p>OR:<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd /etc/openvpn/</span><br><span class="line">mv client.conf server.conf.orig keys/</span><br></pre></td></tr></table></figure></p><h4 id="Windows下客户端："><a href="#Windows下客户端：" class="headerlink" title="Windows下客户端："></a>Windows下客户端：</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&gt; 下载服务器端文件：</span><br><span class="line">ca.crt test.crt test.key client.conf</span><br><span class="line"></span><br><span class="line">打包，复制到</span><br><span class="line">&gt; OpenVPN/conf/</span><br><span class="line"></span><br><span class="line">default client.conf:</span><br><span class="line">&gt; egrep -v <span class="string">"^#|;|^$"</span> keys/client.conf </span><br><span class="line">client</span><br><span class="line">dev tun</span><br><span class="line">proto udp   &lt;</span><br><span class="line">remote 59.108.85.71 5911    &lt; </span><br><span class="line">resolv-retry infinite</span><br><span class="line">nobind</span><br><span class="line">persist-key</span><br><span class="line">persist-tun</span><br><span class="line">ca ca.crt</span><br><span class="line">cert test.crt</span><br><span class="line">key test.key</span><br><span class="line">ns-cert-type server</span><br><span class="line">comp-lzo</span><br><span class="line">verb 3</span><br></pre></td></tr></table></figure><p>企业生产环境client.conf配置：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">client</span><br><span class="line">dev tun</span><br><span class="line">proto udp</span><br><span class="line"><span class="comment"># 协议需要和服务器端一致</span></span><br><span class="line">remote 10.0.0.28 52115</span><br><span class="line"><span class="comment"># 服务器外网IP</span></span><br><span class="line">resolv-retry infinite</span><br><span class="line">nobind</span><br><span class="line">persist-key</span><br><span class="line">persist-tun</span><br><span class="line">ca ca.crt</span><br><span class="line">* </span><br><span class="line">cert oldboy.crt</span><br><span class="line">key oldboy.key</span><br><span class="line">* </span><br><span class="line">comp-lzo</span><br><span class="line">verb 3</span><br></pre></td></tr></table></figure><p>拷贝上面内容成test.ovpn，放入config</p><h1 id="tcpdump-debug"><a href="#tcpdump-debug" class="headerlink" title="tcpdump debug"></a>tcpdump debug</h1><h2 id="在VPN的内网机器添加返回路由或者干脆把vpnserver的IP当作内网服务器的网关。"><a href="#在VPN的内网机器添加返回路由或者干脆把vpnserver的IP当作内网服务器的网关。" class="headerlink" title="在VPN的内网机器添加返回路由或者干脆把vpnserver的IP当作内网服务器的网关。"></a>在VPN的内网机器添加返回路由或者干脆把vpnserver的IP当作内网服务器的网关。</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">route add default gw 172.16.1.28</span><br><span class="line">route del default gw 172.16.1.28</span><br><span class="line">OR：</span><br><span class="line">route add -net 10.8.0.0/24 gw 172.16.1.28</span><br></pre></td></tr></table></figure><p><em>问题：</em></p><blockquote><p>当vpn客户端的GW不是vpn server内网地址的时候，所有的vpn客户端都要添加网络路由<br>此配置重启会失效，需要配置静态路由。参考oldboy博客</p><ul><li>1、/etc/sysconfig/static-router</li><li>2、/etc/sysconfig/network-script/route-eth0</li><li>3、放在rc.local</li></ul></blockquote><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><h2 id="成功连接（客户端日志）："><a href="#成功连接（客户端日志）：" class="headerlink" title="成功连接（客户端日志）："></a>成功连接（客户端日志）：</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&gt; Sat Oct 24 19:34:06 2015 C:\WINDOWS\system32\route.exe ADD 192.168.20.0 MASK 255.255.255.0 10.8.0.5</span><br><span class="line">Sat Oct 24 19:34:06 2015 ROUTE: CreateIpForwardEntry succeeded with dwForwardMetric1=30 and dwForwardType=4</span><br><span class="line">Sat Oct 24 19:34:06 2015 Route addition via IPAPI succeeded [adaptive]</span><br><span class="line">Sat Oct 24 19:34:06 2015 C:\WINDOWS\system32\route.exe ADD 192.168.10.0 MASK 255.255.255.0 10.8.0.5</span><br><span class="line">Sat Oct 24 19:34:06 2015 ROUTE: CreateIpForwardEntry succeeded with dwForwardMetric1=30 and dwForwardType=4</span><br><span class="line">Sat Oct 24 19:34:06 2015 Route addition via IPAPI succeeded [adaptive]</span><br><span class="line">Sat Oct 24 19:34:06 2015 C:\WINDOWS\system32\route.exe ADD 10.8.0.0 MASK 255.255.255.0 10.8.0.5</span><br><span class="line">Sat Oct 24 19:34:06 2015 ROUTE: CreateIpForwardEntry succeeded with dwForwardMetric1=30 and dwForwardType=4</span><br><span class="line">Sat Oct 24 19:34:06 2015 Route addition via IPAPI succeeded [adaptive]</span><br><span class="line">Sat Oct 24 19:34:06 2015 Initialization Sequence Completed</span><br></pre></td></tr></table></figure><h2 id="断开连接（客户端日志）："><a href="#断开连接（客户端日志）：" class="headerlink" title="断开连接（客户端日志）："></a>断开连接（客户端日志）：</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&gt; Sat Oct 24 20:22:52 2015 TCP/UDP: Closing socket</span><br><span class="line">*Sat Oct 24 20:22:52 2015 C:\WINDOWS\system32\route.exe DELETE 10.8.0.0 MASK 255.255.255.0 10.8.0.5*</span><br><span class="line">Sat Oct 24 20:22:52 2015 Route deletion via IPAPI succeeded [adaptive]</span><br><span class="line">Sat Oct 24 20:22:52 2015 C:\WINDOWS\system32\route.exe DELETE 192.168.10.0 MASK 255.255.255.0 10.8.0.5</span><br><span class="line">Sat Oct 24 20:22:52 2015 Route deletion via IPAPI succeeded [adaptive]</span><br><span class="line">Sat Oct 24 20:22:52 2015 C:\WINDOWS\system32\route.exe DELETE 192.168.20.0 MASK 255.255.255.0 10.8.0.5</span><br><span class="line">Sat Oct 24 20:22:52 2015 Route deletion via IPAPI succeeded [adaptive]</span><br><span class="line">Sat Oct 24 20:22:52 2015 Closing TUN/TAP interface</span><br><span class="line">Sat Oct 24 20:22:52 2015 SIGTERM[hard,] received, process exiting</span><br></pre></td></tr></table></figure><h1 id="设置NAT方式的VPN"><a href="#设置NAT方式的VPN" class="headerlink" title="设置NAT方式的VPN"></a>设置NAT方式的VPN</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">10.8.0.6变成内网192.168.20.11</span><br><span class="line"></span><br><span class="line">192.168.20.11 ==&gt; 192.168.20.12</span><br></pre></td></tr></table></figure><h2 id="对应的防火墙规则为："><a href="#对应的防火墙规则为：" class="headerlink" title="对应的防火墙规则为："></a>对应的防火墙规则为：</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eth1 -j SNAT --to-source 172.16.1.28</span><br><span class="line"></span><br><span class="line">OR</span><br><span class="line">[IP 地址伪装]</span><br><span class="line">iptables -t nat -I POSTROUTING -s 10.8.0.0/24 -o eth1 -j MASQUERADE</span><br></pre></td></tr></table></figure><blockquote><p>通过eth1,转接 10.8的地址为172.16.1.28</p></blockquote><p>办公网络添加实例：</p><blockquote><p>iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o em2 -j SNAT –to-source 192.168.20.11<br>最后一项配置会修改客户端的默认路由为OpenVPN服务器。这样，通常还必须加入NAT转换：<br>iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o em2 -j MASQUERADE</p></blockquote><h2 id="默认防火墙规则"><a href="#默认防火墙规则" class="headerlink" title="默认防火墙规则"></a>默认防火墙规则</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Chain FORWARD</span><br><span class="line">target  prot    opt <span class="built_in">source</span>  des     </span><br><span class="line">REJECT  all     --  0.0.0.0 0.0.0.0 reject-with icmp-host-prohibited</span><br><span class="line"></span><br><span class="line">&gt; 取消这条Forward规则：</span><br><span class="line">cat /etc/sysconfig/iptables</span><br><span class="line">或者添加（从虚拟网卡进来就转发）：</span><br><span class="line">iptables -A FORWARD -i tunt -j ACCEPT</span><br></pre></td></tr></table></figure><h3 id="openvpn-内置规则"><a href="#openvpn-内置规则" class="headerlink" title="openvpn 内置规则"></a>openvpn 内置规则</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/src/openvpn-2.2.2/sample-config-files/firewall.sh</span><br></pre></td></tr></table></figure><h2 id="适用场景："><a href="#适用场景：" class="headerlink" title="适用场景："></a>适用场景：</h2><ol><li>适合app client的网关不是vpn server的场景。如果app client的网关为vpn server则不用nat转发。</li></ol><h2 id="路由和nat模式区别："><a href="#路由和nat模式区别：" class="headerlink" title="路由和nat模式区别："></a>路由和nat模式区别：</h2><ol><li>nat适合app client的网关不是vpn server的场景。</li><li>如果app client不是app server，又不用nat方式，还可以手动添加路由。（缺点是每个app client客户端都需要配置路由）<br>推荐：NAT，因为企业的多数场景，内部服务器的网关通常不是vpn server</li></ol><h2 id="企业vpn服务器维护"><a href="#企业vpn服务器维护" class="headerlink" title="企业vpn服务器维护"></a>企业vpn服务器维护</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> openvpn-2.2.2/</span><br><span class="line"><span class="built_in">cd</span> easy-rsa/2.0/</span><br><span class="line"><span class="built_in">source</span> vars</span><br><span class="line">然后再运行</span><br><span class="line">./build-key client_name或</span><br><span class="line">./build-key-pass client_name</span><br><span class="line">ll easy-rsa/2.0/keys/</span><br></pre></td></tr></table></figure><h1 id="企业发送证书给同事案例"><a href="#企业发送证书给同事案例" class="headerlink" title="企业发送证书给同事案例"></a>企业发送证书给同事案例</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt; 附件清单如下：</span><br><span class="line">xiaowang-key.zip        --- 里面是证书和配置文件</span><br><span class="line">openvpn-2.2.2-install.exe  --- windows7 及以上系统请用这个客户端</span><br><span class="line">如果win7的系统发现无法使用，请百度“openvpn windows7客户端”</span><br><span class="line">请大家表领错证书哈。</span><br><span class="line">首先，安装，默认路径，安装过程简单，多了红色电脑，不用管。</span><br><span class="line">安装后，解压证书压缩包，里面共6文件，将里面的6文件覆盖到OpenVPN\config里面</span><br><span class="line">覆盖后，双击右下角的红色电脑，弹出窗口，不用管，自动拨号。成功绿色，隐藏。</span><br></pre></td></tr></table></figure><h2 id="穿墙"><a href="#穿墙" class="headerlink" title="穿墙"></a>穿墙</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 和普通的配置相比，server.conf需要增加：</span></span><br><span class="line">push <span class="string">"redirect-gateway def1 bypass-dhcp bypass-dns"</span></span><br><span class="line">push <span class="string">"dhcp-option DNS"</span></span><br><span class="line">push <span class="string">"dhcp-option DNS"</span></span><br></pre></td></tr></table></figure><blockquote><p>完整配置如下：</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">local</span> xxxx</span><br><span class="line">port xxxx</span><br><span class="line">proto udp</span><br><span class="line">dev tun</span><br><span class="line">ca ca.crt</span><br><span class="line">cert server.crt</span><br><span class="line">key server.key</span><br><span class="line">dh dh1024.pem</span><br><span class="line">server 10.8.0.0 255.255.255.0</span><br><span class="line">push <span class="string">"route 10.0.0.0 255.255.255.0"</span></span><br><span class="line">push <span class="string">"redirect-gateway def1 bypass-dhcp bypass-dns"</span></span><br><span class="line">push <span class="string">"dhcp-option DNS"</span></span><br><span class="line">push <span class="string">"dhcp-option DNS"</span></span><br><span class="line"></span><br><span class="line">ifconfig-pool-persist ipp.txt</span><br><span class="line">client-to-client</span><br><span class="line">duplicate-cn</span><br><span class="line">keepalive 10 120</span><br><span class="line">comp-lzo</span><br><span class="line">persist-key</span><br><span class="line">persist-tun</span><br><span class="line">status /var/<span class="built_in">log</span>/openvpn/openvpn-status.log</span><br><span class="line"><span class="built_in">log</span> /var/<span class="built_in">log</span>/openvpn/openvpn.log</span><br><span class="line">verb 3</span><br></pre></td></tr></table></figure><h1 id="吊销证书"><a href="#吊销证书" class="headerlink" title="吊销证书"></a>吊销证书</h1><h2 id="单个"><a href="#单个" class="headerlink" title="单个"></a>单个</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> 2.0/</span><br><span class="line"><span class="built_in">source</span> vars</span><br><span class="line">如果吊销有问题，请注释openssl.cnf后6行。</span><br><span class="line">./revoke-full client_name</span><br><span class="line">被吊销的用户（前面有R）：</span><br><span class="line">cat keys/index.txt</span><br><span class="line">cp keys/crl.pem /etc/openvpn/keys/</span><br><span class="line">cat &gt;&gt; server.conf &lt;&lt; EOF</span><br><span class="line">crl-verify /etc/openvpn/keys/crl.pem</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="多个"><a href="#多个" class="headerlink" title="多个"></a>多个</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">同单个，都是加载删除列表。</span><br></pre></td></tr></table></figure><h1 id="Linux安装vpn客户端"><a href="#Linux安装vpn客户端" class="headerlink" title="Linux安装vpn客户端"></a>Linux安装vpn客户端</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">1. 安装lzo模块</span><br><span class="line">2. 安装openvpn</span><br><span class="line">mkdir -p /etc/openvpn</span><br><span class="line">上传证书包</span><br><span class="line"><span class="built_in">cd</span> /etc/openvpn</span><br><span class="line">mv test.ovpn client.conf</span><br></pre></td></tr></table></figure><h2 id="排错"><a href="#排错" class="headerlink" title="排错"></a>排错</h2><blockquote><p>如果报’–script-security 2’warning，则：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cat &gt;&gt; client_name.ovpn &lt;&lt; EOF</span><br><span class="line">--script-security 2</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p>如果碰到’Cant load cert ‘，修改linux.conf为c.conf</p></blockquote><h2 id="验证"><a href="#验证" class="headerlink" title="[验证]"></a>[验证]</h2><blockquote><p>ping内网的机器</p></blockquote><h1 id="Linux-openvpn-client使用场景"><a href="#Linux-openvpn-client使用场景" class="headerlink" title="Linux openvpn client使用场景"></a>Linux openvpn client使用场景</h1><ol><li>多办公室或者多个企业网络互联</li><li>办公室的Linux（如svn）同步数据到机房某个内网的机器</li><li>跨机房的数据备份（备份服务器没有外网IP）</li><li>摘掉所有不是必须使用外网IP的服务器（nagios，web）</li></ol><h1 id="多机房利用vpn互联架构"><a href="#多机房利用vpn互联架构" class="headerlink" title="多机房利用vpn互联架构"></a>多机房利用vpn互联架构</h1><h2 id="逻辑："><a href="#逻辑：" class="headerlink" title="逻辑："></a>逻辑：</h2><blockquote><p>每个机房的机器使用openvpn server的内网ip地址作为网关。<br>Lclient:    Lserver:vpnclient   rserver:vpnserver rclient<br>eth0:       eth0:10.0.0.29      eth0:10.0.0.28  eth0:172.16.1.17<br>192.168.1.17 eth1:192.168.1.29  eth1:172.16.1.28    GW:172.16.1.28<br>GW:         GW:10.0.0.254       GW:10.0.0.254<br>192.168.1.29</p></blockquote><p><em>需求</em>:</p><ol><li>Lclient 可以ping通172.16.1.17</li><li>rclient 可以ping通192.168.1.17</li></ol><h2 id="实际案例："><a href="#实际案例：" class="headerlink" title="实际案例："></a>实际案例：</h2><blockquote><ol><li>不做网关的玩法：###<br>client-conf-dir /usr/local/vpn/ccd<br>route       192.168.1.0 255.255.255.0</li></ol></blockquote><pre><code>### 让局域网内的机器通过做网关的vpn client与vpn server局域网内部的机器通信。</code></pre><p>1.1. ### 在/usr/local/vpn/ccd下建立<br>web177# more xp<br>iroute 192.168.1.0  255.255.255.0<br>1.2.配置vpn客户端，同时把路由功能打开。ip_forward=1<br>1.3. vpn server的局域网服务器，增加一条到vpn client的路由。<br>route add 10.8.0.0/24 192.168.2.177<br>增加一条到vpn client后端服务器的路由：<br>route add 192.168.1.0/24 192.168.2.177</p><p>关键字：openvpn多机房互联。</p><h2 id="多机房利用openvpn应用场景："><a href="#多机房利用openvpn应用场景：" class="headerlink" title="多机房利用openvpn应用场景："></a>多机房利用openvpn应用场景：</h2><blockquote><ol><li>企业之间互联</li><li>多机房互联：<br> a. 数据同步、备份<br> b. 异地数据读取、写入<br>通过VPN传数据，本地读、远程写。</li></ol></blockquote><blockquote><p>蓝汛：每入职一个运维，开一个跳板机普通帐号，这个帐号可以访问任何机器（调用机器列表）。<br>赶集网：两层代理，每个机房一个代理，每台机器10个已经设定好权限的帐号</p></blockquote><h1 id="route、tcpdump总结"><a href="#route、tcpdump总结" class="headerlink" title="route、tcpdump总结"></a>route、tcpdump总结</h1><h1 id="远程vpn架构，多机房互联"><a href="#远程vpn架构，多机房互联" class="headerlink" title="远程vpn架构，多机房互联"></a>远程vpn架构，多机房互联</h1><h1 id="LDAP-插件结合预热"><a href="#LDAP-插件结合预热" class="headerlink" title="LDAP 插件结合预热"></a>LDAP 插件结合预热</h1><h2 id="插件："><a href="#插件：" class="headerlink" title="插件："></a>插件：</h2><blockquote><p>openvpn-auth-ldap</p></blockquote><ol><li>编译安装</li><li>yum 安装</li></ol><h1 id="8种openvpn验证方式"><a href="#8种openvpn验证方式" class="headerlink" title="8种openvpn验证方式"></a>8种openvpn验证方式</h1><h2 id="本地证书密钥认证"><a href="#本地证书密钥认证" class="headerlink" title="本地证书密钥认证"></a>本地证书密钥认证</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/openvpn</span><br><span class="line">cat server.conf</span><br><span class="line">    auth-user-pass-verify /etc/openvpn/checkpsw.sh via-env</span><br><span class="line">    client-cert-not-required</span><br><span class="line">    username-as-common-name</span><br></pre></td></tr></table></figure><p>获取：checkpsw.sh</p><blockquote></blockquote><h2 id="本地文件认证"><a href="#本地文件认证" class="headerlink" title="本地文件认证"></a>本地文件认证</h2><h2 id="通过mysql数据库认证"><a href="#通过mysql数据库认证" class="headerlink" title="通过mysql数据库认证"></a>通过mysql数据库认证</h2><h2 id="LDAP认证"><a href="#LDAP认证" class="headerlink" title="LDAP认证"></a>LDAP认证</h2><h3 id="openvpn-auth-ldap"><a href="#openvpn-auth-ldap" class="headerlink" title="openvpn-auth-ldap"></a>openvpn-auth-ldap</h3><h3 id="利用第一个文件认证的思路，去LDAP查询，还可以和本地文件比较，将授权和认证分开。"><a href="#利用第一个文件认证的思路，去LDAP查询，还可以和本地文件比较，将授权和认证分开。" class="headerlink" title="利用第一个文件认证的思路，去LDAP查询，还可以和本地文件比较，将授权和认证分开。"></a>利用第一个文件认证的思路，去LDAP查询，还可以和本地文件比较，将授权和认证分开。</h3><h2 id="结合radius认证"><a href="#结合radius认证" class="headerlink" title="结合radius认证"></a>结合radius认证</h2><h2 id="结合AD"><a href="#结合AD" class="headerlink" title="结合AD"></a>结合AD</h2><h2 id="结合U盾等设备认证"><a href="#结合U盾等设备认证" class="headerlink" title="结合U盾等设备认证"></a>结合U盾等设备认证</h2><h1 id="VPN不做网关情况的企业多机房VPN互联"><a href="#VPN不做网关情况的企业多机房VPN互联" class="headerlink" title="VPN不做网关情况的企业多机房VPN互联"></a>VPN不做网关情况的企业多机房VPN互联</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">route add -net 192.168.1.0/24 gw 172.16.1.28</span><br></pre></td></tr></table></figure><blockquote><p>表示：去192.168.1.0网段，使用172.16.1.28做网关</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">route add default gw 172.16.1.39</span><br></pre></td></tr></table></figure><blockquote><p>表示：访问0.0.0.0的网段，使用172.16.1.39做默认网关</p></blockquote><h3 id="本地文件验证"><a href="#本地文件验证" class="headerlink" title="本地文件验证"></a>本地文件验证</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cat &gt;&gt; server.conf</span><br><span class="line">auth-user-pass-verify /etc/openvpn/checkpsw.sh via-env</span><br><span class="line">client-cert-not-required</span><br><span class="line">username-as-common-name</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h1 id="开发脚本实现openvpn通过ldap验证"><a href="#开发脚本实现openvpn通过ldap验证" class="headerlink" title="开发脚本实现openvpn通过ldap验证"></a>开发脚本实现openvpn通过ldap验证</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">*user-auth.conf 用户授权文件(类似于svn)*</span><br><span class="line">*user.conf 测试用ldap用户、密码*</span><br><span class="line">*check_credit.py 验证脚本文件*</span><br></pre></td></tr></table></figure><h2 id="如果本地文件验证出现error-TLS-8172-error"><a href="#如果本地文件验证出现error-TLS-8172-error" class="headerlink" title="如果本地文件验证出现error : TLS-8172 error"></a>如果本地文件验证出现error : TLS-8172 error</h2><p>cat &gt;&gt; /etc/openldap/ldap.conf &lt;&lt;(Cent 6.x)<br>TLS_REQCERT allow<br>EOF</p><p>cat &gt;&gt; /etc/ldap.conf &lt;&lt;(Cent 5.x)<br>TLS_REQCERT allow<br>EOF</p><h2 id="ldap实战"><a href="#ldap实战" class="headerlink" title="ldap实战"></a>ldap实战</h2><p>cat &gt;&gt; /etc/openldap/ server.conf &lt;&lt;</p><blockquote><p>//# for python script ldap-auth<br>script-security 2<br>auth-user-pass-verify “/usr/bin/python /etc/openvpn/check_credit.py” via-file<br>client-cert-not-required<br>username-as-common-name<br>tmp-dir /dev/shm<br>auth-nocache</p></blockquote><blockquote><p>via-env方式是openvpn将客户端提供的用户名、密码字符串设置成调用脚本的环境变量；via-file方式将ldap的用户名密码写入临时文件头两行，返回后删除。如果脚本坚持用户名密码，返回0成功，1失败。</p></blockquote><h3 id="客户端配置"><a href="#客户端配置" class="headerlink" title="客户端配置"></a>客户端配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cat &gt;&gt; client.ovpn &lt;&lt;</span><br><span class="line">//<span class="comment"># cert cl.cert</span></span><br><span class="line">//<span class="comment"># key xiaowang.key</span></span><br><span class="line">auth-user-pass</span><br><span class="line">auth-nocache</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">### server端配置</span></span><br><span class="line">cat &gt;&gt; check_credit.py &lt;&lt;</span><br><span class="line">log_filename=<span class="string">''</span></span><br><span class="line">auth_filename=<span class="string">''</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="普通生产版本client-opvn"><a href="#普通生产版本client-opvn" class="headerlink" title="普通生产版本client.opvn"></a>普通生产版本client.opvn</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&gt; client</span><br><span class="line">proto udp</span><br><span class="line">dev tun</span><br><span class="line">remote auto.company.com 5911</span><br><span class="line">resolv-retry infinite</span><br><span class="line">nobind</span><br><span class="line">\<span class="comment"># user nobody</span></span><br><span class="line">\<span class="comment"># group nobody</span></span><br><span class="line">persist-key</span><br><span class="line">persist-tun</span><br><span class="line">ca ca.crt</span><br><span class="line">comp-lzo</span><br><span class="line">verb 3</span><br><span class="line">auth-user-pass</span><br><span class="line">auth-nocache</span><br><span class="line">reneg-sec 360000</span><br></pre></td></tr></table></figure><h3 id="ldap验证生产版本client-ovpn"><a href="#ldap验证生产版本client-ovpn" class="headerlink" title="ldap验证生产版本client.ovpn"></a>ldap验证生产版本client.ovpn</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt; client</span><br><span class="line">dev tun</span><br><span class="line">\# proto tcp</span><br><span class="line">proto udp</span><br><span class="line">remote vpn.company.com 5911</span><br><span class="line">resolv-retry 60</span><br><span class="line">\# resolv-retry infinite</span><br><span class="line">nobind</span><br><span class="line">persist-key</span><br><span class="line">persist-tun</span><br><span class="line">ca ca.crt</span><br><span class="line">\# cert xx.crt</span><br><span class="line">\# key xx.key</span><br><span class="line">ns-cert-type server</span><br><span class="line">comp-lzo</span><br><span class="line">verb 3</span><br><span class="line">auth-user-pass</span><br><span class="line">auth-nocache</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;openvpn搭建&quot;&gt;&lt;a href=&quot;#openvpn搭建&quot; class=&quot;headerlink&quot; title=&quot;openvpn搭建&quot;&gt;&lt;/a&gt;openvpn搭建&lt;/h1&gt;&lt;h2 id=&quot;应用场景&quot;&gt;&lt;a href=&quot;#应用场景&quot; class=&quot;headerli
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Integrate tengine with libressl to support chacha20-ietf-poly1305</title>
    <link href="https://hexo.io/news/2019/01/09/2019-01-09-Integrate-tengine-with-libressl-to-support-chacha20-ietf-poly1305.html"/>
    <id>https://hexo.io/news/2019/01/09/2019-01-09-Integrate-tengine-with-libressl-to-support-chacha20-ietf-poly1305.html</id>
    <published>2019-01-09T10:09:46.000Z</published>
    <updated>2019-01-12T07:19:20.000Z</updated>
    
    <content type="html"><![CDATA[<hr><h2 id="更换背景"><a href="#更换背景" class="headerlink" title="更换背景"></a>更换背景</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Mac 基础套件ssh, php以及alpine Linux已经切换openssl到libressl</span></span><br><span class="line">➜  ~ ssh -V</span><br><span class="line">OpenSSH_7.8p1, LibreSSL 2.6.2</span><br><span class="line"></span><br><span class="line">➜  ~ php -i</span><br><span class="line">phpinfo()</span><br><span class="line">PHP Version =&gt; 7.1.16</span><br><span class="line"></span><br><span class="line">root:xnu-4570.71.17~1/RELEASE_X86_64 x86_64</span><br><span class="line">Build Date =&gt; Apr  1 2018 13:47:29</span><br><span class="line">Configure Command =&gt; <span class="string">'....</span></span><br><span class="line"><span class="string">--with-openssl=/BuildRoot/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.13.Internal.sdk/usr/local/libressl</span></span><br><span class="line"><span class="string">...'</span></span><br></pre></td></tr></table></figure><h2 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明"></a>环境说明</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat /etc/redhat-release</span><br><span class="line">CentOS Linux release 7.6.1810 (Core)</span><br><span class="line"></span><br><span class="line">$ uname -a</span><br><span class="line">Linux izj6c0ahnyudgp7qwa7ah8z 4.14.90 <span class="comment">#1 SMP Mon Dec 24 04:50:20 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux</span></span><br></pre></td></tr></table></figure><h2 id="编译libressl"><a href="#编译libressl" class="headerlink" title="编译libressl"></a>编译libressl</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src/</span><br><span class="line">wget -c https://ftp.openbsd.org/pub/OpenBSD/LibreSSL/libressl-2.6.5.tar.gz</span><br><span class="line"><span class="comment"># centos 7 gcc需要额外设置编译参数-fPIC</span></span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src/libressl/</span><br><span class="line"><span class="built_in">export</span> CFLAGS=<span class="string">"<span class="variable">$CFLAGS</span> -fPIC -g -O2"</span> &amp;&amp; ./config --prefix=/usr/<span class="built_in">local</span>/src/libressl/.openssl no-shared</span><br><span class="line">make -j4 &amp;&amp; make install-strip distclean</span><br><span class="line"><span class="built_in">unset</span> CFLAGS</span><br></pre></td></tr></table></figure><h2 id="编译tengine，使用libressl"><a href="#编译tengine，使用libressl" class="headerlink" title="编译tengine，使用libressl"></a>编译tengine，使用libressl</h2><hr><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src/tengine/</span><br><span class="line">make clean</span><br><span class="line"></span><br><span class="line">./configure \</span><br><span class="line">--prefix=/usr/share/nginx \</span><br><span class="line">--conf-path=/etc/nginx/nginx.conf \</span><br><span class="line">--error-log-path=/var/<span class="built_in">log</span>/nginx/error.log \</span><br><span class="line">--http-client-body-temp-path=/var/cache/nginx/client_temp \</span><br><span class="line">--http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp \</span><br><span class="line">--http-log-path=/var/<span class="built_in">log</span>/nginx/access.log \</span><br><span class="line">--http-proxy-temp-path=/var/cache/nginx/proxy_temp \</span><br><span class="line">--http-scgi-temp-path=/var/cache/nginx/scgi_temp \</span><br><span class="line">--http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp \</span><br><span class="line">--lock-path=/var/run/lock/nginx.lock \</span><br><span class="line">--pid-path=/var/run/nginx.pid \</span><br><span class="line">--sbin-path=/usr/sbin/nginx \</span><br><span class="line">--dso-tool-path=/usr/sbin/dso_tool \</span><br><span class="line">--group=nginx \</span><br><span class="line">--user=nginx \</span><br><span class="line">--with-file-aio \</span><br><span class="line">--with-http_addition_module=shared \</span><br><span class="line">--with-http_auth_request_module \</span><br><span class="line">--with-http_concat_module=shared \</span><br><span class="line">--with-http_dav_module \</span><br><span class="line">--with-http_degradation_module \</span><br><span class="line">--with-http_dyups_module \</span><br><span class="line">--with-http_flv_module=shared \</span><br><span class="line">--with-http_geoip_module=shared \</span><br><span class="line">--with-http_gunzip_module \</span><br><span class="line">--with-http_gzip_static_module \</span><br><span class="line">--with-http_memcached_module=shared \</span><br><span class="line">--with-http_random_index_module=shared \</span><br><span class="line">--with-http_realip_module \</span><br><span class="line">--with-http_reqstat_module=shared \</span><br><span class="line">--with-http_secure_link_module=shared \</span><br><span class="line">--with-http_slice_module=shared \</span><br><span class="line">--with-http_sub_module=shared \</span><br><span class="line">--with-http_sysguard_module=shared \</span><br><span class="line">--with-http_v2_module \</span><br><span class="line">--with-ipv6 \</span><br><span class="line">--with-jemalloc \</span><br><span class="line">--with-http_xslt_module=shared \</span><br><span class="line">--with-pcre \</span><br><span class="line">--with-pcre-jit \</span><br><span class="line">--with-openssl=/usr/<span class="built_in">local</span>/src/libressl \</span><br><span class="line">--with-cc-opt=<span class="string">'-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=native -fPIC'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新libressl header文件时间戳防止再次编译</span></span><br><span class="line">touch /usr/<span class="built_in">local</span>/src/libressl/.openssl/include/openssl/ssl.h</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译安装</span></span><br><span class="line">make -j3 &amp;&amp; sudo make install clean &amp;&amp; sudo mkdir -pv /var/cache/nginx/client_temp</span><br></pre></td></tr></table></figure><h2 id="启动脚本"><a href="#启动脚本" class="headerlink" title="启动脚本"></a>启动脚本</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@nat-gw-jms-254-2 ~]<span class="comment"># cat &gt; /usr/lib/systemd/system/nginx.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=The nginx HTTP and reverse proxy server</span><br><span class="line">After=network.target remote-fs.target nss-lookup.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">PIDFile=/run/nginx.pid</span><br><span class="line"><span class="comment"># Nginx will fail to start if /run/nginx.pid already exists but has the wrong</span></span><br><span class="line"><span class="comment"># SELinux context. This might happen when running `nginx -t` from the cmdline.</span></span><br><span class="line"><span class="comment"># https://bugzilla.redhat.com/show_bug.cgi?id=1268621</span></span><br><span class="line">ExecStartPre=/usr/bin/rm -f /run/nginx.pid</span><br><span class="line">ExecStartPre=/usr/sbin/nginx -t</span><br><span class="line">ExecStart=/usr/sbin/nginx</span><br><span class="line">ExecReload=/bin/<span class="built_in">kill</span> -s HUP <span class="variable">$MAINPID</span></span><br><span class="line">KillSignal=SIGQUIT</span><br><span class="line">TimeoutStopSec=5</span><br><span class="line">KillMode=process</span><br><span class="line">PrivateTmp=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h2 id="额外设置"><a href="#额外设置" class="headerlink" title="额外设置"></a>额外设置</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">chkconfig nginx on</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;hr&gt;
&lt;h2 id=&quot;更换背景&quot;&gt;&lt;a href=&quot;#更换背景&quot; class=&quot;headerlink&quot; title=&quot;更换背景&quot;&gt;&lt;/a&gt;更换背景&lt;/h2&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;
      
    
    </summary>
    
    
  </entry>
  
</feed>
