<!DOCTYPE html>
<html lang="zh-cn">
<head prefix="og: http://ogp.me/ns#"><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  <title>dns and smart dns | W0ng.Unic0rn blog</title>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Canonical links -->
  <link rel="canonical" href="https://hexo.io/news/2019/01/12/2019-01-12-dns-and-smart-dns.html">
  <!-- Alternative links -->
  
  <!-- Icon -->
  <link rel="apple-touch-icon" sizes="57x57" href="/icon/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icon/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icon/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icon/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icon/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icon/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icon/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icon/apple-touch-icon-152x152.png">
  <link rel="icon" type="image/png" href="/icon/favicon-196x196.png" sizes="196x196">
  <link rel="icon" type="image/png" href="/icon/favicon-160x160.png" sizes="160x160">
  <link rel="icon" type="image/png" href="/icon/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="/icon/favicon-16x16.png" sizes="16x16">
  <link rel="icon" type="image/png" href="/icon/favicon-32x32.png" sizes="32x32">
  <meta name="msapplication-TileColor" content="#2f83cd">
  <meta name="msapplication-TileImage" content="/icon/mstile-144x144.png">
  <!-- CSS -->
  <!-- build:css build/css/navy.css -->
  <link rel="stylesheet" href="/css/navy.css">
  <!-- endbuild -->
  <link href="https://fonts.googleapis.com/css?family=Lato:300,400,700" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css">
  <!-- RSS -->
  <link rel="alternate" href="/atom.xml" title="W0ng.Unic0rn blog">
  <!-- Open Graph -->
  <meta name="description" content="DNS与智能DNS服务2. client端设定配置文件 /etc/hosts早期hostname对应IP的文件   /etc/resolv.conf主机dns配置   /etc/nsswitch.confdns查询优先级hostslink```## 查询命令### host### nslookup&amp;gt; A记录：IP地址&amp;gt; PTR：反解&amp;gt; MX：邮件交换器&amp;gt; NS：DNS服务器">
<meta property="og:type" content="article">
<meta property="og:title" content="dns and smart dns">
<meta property="og:url" content="https://hexo.io/news/2019/01/12/2019-01-12-dns-and-smart-dns.html">
<meta property="og:site_name" content="W0ng.Unic0rn blog">
<meta property="og:description" content="DNS与智能DNS服务2. client端设定配置文件 /etc/hosts早期hostname对应IP的文件   /etc/resolv.conf主机dns配置   /etc/nsswitch.confdns查询优先级hostslink```## 查询命令### host### nslookup&amp;gt; A记录：IP地址&amp;gt; PTR：反解&amp;gt; MX：邮件交换器&amp;gt; NS：DNS服务器">
<meta property="og:locale" content="zh-cn">
<meta property="og:updated_time" content="2019-01-12T09:08:39.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="dns and smart dns">
<meta name="twitter:description" content="DNS与智能DNS服务2. client端设定配置文件 /etc/hosts早期hostname对应IP的文件   /etc/resolv.conf主机dns配置   /etc/nsswitch.confdns查询优先级hostslink```## 查询命令### host### nslookup&amp;gt; A记录：IP地址&amp;gt; PTR：反解&amp;gt; MX：邮件交换器&amp;gt; NS：DNS服务器">
  <!-- Google Analytics -->
  
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-6482217598104186",
          enable_page_level_ads: true
     });
  </script>
</head>

<body>
  <div id="container">
    <header id="header" class="wrapper">
  <div id="header-inner" class="inner">
    <h1 id="logo-wrap">
      <a href="/zh-cn/" id="logo">Hexo</a>
    </h1>
    <nav id="main-nav">
      <a href="/zh-cn/docs/" class="main-nav-link">文档</a><a href="/zh-cn/api/" class="main-nav-link">API</a><a href="/news/" class="main-nav-link">新闻</a><a href="/plugins/" class="main-nav-link">插件</a><a href="/themes/" class="main-nav-link">主题</a>
      <a href="https://github.com/" class="main-nav-link"><i class="fa fa-github-alt"></i></a>
      <div id="search-input-wrap">
        <div id="search-input-icon">
          <i class="fa fa-search"></i>
        </div>
        <input type="search" id="search-input" placeholder="Search...">
      </div>
    </nav>
    <div id="lang-select-wrap">
      <label id="lang-select-label"><i class="fa fa-globe"></i><span>简体中文</span></label>
      <select id="lang-select" data-canonical="">
        
          <option value="en">English</option>
        
          <option value="zh-tw">正體中文</option>
        
          <option value="zh-cn" selected>简体中文</option>
        
          <option value="ru">Русский</option>
        
          <option value="ko">한국어</option>
        
          <option value="pt-br">Português (Brasil)</option>
        
          <option value="th">ภาษาไทย</option>
        
      </select>
    </div>
    <a id="mobile-nav-toggle">
      <span class="mobile-nav-toggle-bar"></span>
      <span class="mobile-nav-toggle-bar"></span>
      <span class="mobile-nav-toggle-bar"></span>
    </a>
  </div>
</header>

    <div id="content-wrap">
  <div class="wrapper">
    <div class="inner">
      <article class="article post" itemscope itemtype="http://schema.org/Article">
  <header class="article-header">
    
      <h1 class="article-title" itemprop="name">dns and smart dns</h1>
    
    <a href="/news/2019/01/12/2019-01-12-dns-and-smart-dns.html" class="article-date"><time datetime="2019-01-12T09:05:43.000Z">2019-01-12</time></a>
  </header>
  <div class="article-content" itemprop="articleBody">
    <h1 id="DNS与智能DNS服务" class="article-heading"><a href="#DNS与智能DNS服务" class="headerlink" title="DNS与智能DNS服务"></a>DNS与智能DNS服务<a class="article-anchor" href="#DNS与智能DNS服务" aria-hidden="true"></a></h1><h1 id="2-client端设定" class="article-heading"><a href="#2-client端设定" class="headerlink" title="2. client端设定"></a>2. client端设定<a class="article-anchor" href="#2-client端设定" aria-hidden="true"></a></h1><h2 id="配置文件" class="article-heading"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件<a class="article-anchor" href="#配置文件" aria-hidden="true"></a></h2><blockquote>
<p>/etc/hosts<br>早期hostname对应IP的文件</p>
</blockquote>
<blockquote>
<p>/etc/resolv.conf<br>主机dns配置</p>
</blockquote>
<blockquote>
<p>/etc/nsswitch.conf<br>dns查询优先级<br><figure class="highlight plain"><figcaption><span>hosts</span><a href="/etc/nsswitch.conf">link</a></figcaption><table><tr><td class="code"><pre><span class="line">```</span><br><span class="line"></span><br><span class="line">## 查询命令</span><br><span class="line">### host</span><br><span class="line"></span><br><span class="line">### nslookup</span><br><span class="line"></span><br><span class="line">&gt; A记录：IP地址</span><br><span class="line"></span><br><span class="line">&gt; PTR：反解</span><br><span class="line"></span><br><span class="line">&gt; MX：邮件交换器</span><br><span class="line"></span><br><span class="line">&gt; NS：DNS服务器</span><br><span class="line"></span><br><span class="line">&gt; TXT：文本信息</span><br><span class="line"></span><br><span class="line">&gt; SOA：用于DNS Zone的“起始授权机构”</span><br><span class="line"></span><br><span class="line">### dig</span><br><span class="line">&gt;</span><br><span class="line">dig xxx.com @DNS-server</span><br><span class="line">&gt; 正解：</span><br><span class="line">dig [-t mx ns txt soa] xxxx.com</span><br><span class="line"></span><br><span class="line">``` bash</span><br><span class="line">[root@ldap ~]# dig 91taogu.com</span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.8.2rc1-RedHat-9.8.2-0.37.rc1.el6_7.7 &lt;&lt;&gt;&gt; 91taogu.com</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 21781</span><br><span class="line">;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0</span><br><span class="line"></span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;91taogu.com.			IN	A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">91taogu.com.		497	IN	A	123.56.149.61</span><br><span class="line"></span><br><span class="line">;; Query time: 97 msec</span><br><span class="line">;; SERVER: 119.29.29.29#53(119.29.29.29)</span><br><span class="line">;; WHEN: Wed Apr 27 14:30:27 2016</span><br><span class="line">;; MSG SIZE  rcvd: 45</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>反解：<br>dig -x ip</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ldap ~]<span class="comment"># dig -x 123.56.149.61</span></span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.8.2rc1-RedHat-9.8.2-0.37.rc1.el6_7.7 &lt;&lt;&gt;&gt; -x 123.56.149.61</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NXDOMAIN, id: 37936</span><br><span class="line">;; flags: qr rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 0</span><br><span class="line"></span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;61.149.56.123.in-addr.arpa.	IN	PTR</span><br><span class="line"></span><br><span class="line">;; AUTHORITY SECTION:</span><br><span class="line">56.123.in-addr.arpa.	508	IN	SOA	hidden-master.aliyun.com. hostmaster.aliyun-inc.com. 2013090588 7200 900 2592000 600</span><br><span class="line"></span><br><span class="line">;; Query time: 7 msec</span><br><span class="line">;; SERVER: 119.29.29.29<span class="comment">#53(119.29.29.29)</span></span><br><span class="line">;; WHEN: Wed Apr 27 14:30:32 2016</span><br><span class="line">;; MSG SIZE  rcvd: 126</span><br></pre></td></tr></table></figure>
<h3 id="whois" class="article-heading"><a href="#whois" class="headerlink" title="whois"></a>whois<a class="article-anchor" href="#whois" aria-hidden="true"></a></h3><blockquote>
</blockquote>
<p>查询域名所有人</p>
<h1 id="3-BIND" class="article-heading"><a href="#3-BIND" class="headerlink" title="3. BIND"></a>3. BIND<a class="article-anchor" href="#3-BIND" aria-hidden="true"></a></h1><h2 id="3-0-安装" class="article-heading"><a href="#3-0-安装" class="headerlink" title="3.0 安装"></a>3.0 安装<a class="article-anchor" href="#3-0-安装" aria-hidden="true"></a></h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install bind bind-utils openssl-devel</span><br></pre></td></tr></table></figure>
<ul>
<li>或者：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install openssl-devel openssl -y</span><br><span class="line">wget http://ftp.isc.org/isc/bind9/9.9.8/<span class="built_in">bind</span>-9.9.8.tar.gz</span><br><span class="line">tar zxf <span class="built_in">bind</span>-9.9.8.tar.gz</span><br><span class="line"><span class="built_in">cd</span> <span class="built_in">bind</span>-9.9.8</span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/named --<span class="built_in">enable</span>-threads --datadir=/usr/share --<span class="built_in">enable</span>-largefile --with-make-clean</span><br><span class="line">make -j4</span><br><span class="line">make install &amp;&amp; <span class="built_in">echo</span> $?</span><br><span class="line">groupadd named</span><br><span class="line">useradd named -g named -d /usr/<span class="built_in">local</span>/named -s /sbin/nologin</span><br><span class="line">mkdir -pv /usr/<span class="built_in">local</span>/named/</span><br><span class="line">chown -R named.named /usr/<span class="built_in">local</span>/named</span><br><span class="line">mkdir -pv /var/named</span><br><span class="line">chown -R named.named /var/named</span><br><span class="line">chown 700 /usr/<span class="built_in">local</span>/named/etc</span><br><span class="line">ln -sf /etc/rndc.conf /usr/<span class="built_in">local</span>/named/etc/rndc.conf</span><br><span class="line">ln -sf /etc/named.conf /usr/<span class="built_in">local</span>/named/etc/named.conf</span><br><span class="line"><span class="comment"># 如果rndc reload报错"ldap named[27224]: the working directory is not writable"</span></span><br><span class="line">请执行：</span><br><span class="line">chown named.root named</span><br><span class="line"><span class="comment">#Startup</span></span><br><span class="line">/usr/<span class="built_in">local</span>/named/sbin/named -c /usr/<span class="built_in">local</span>/named/etc/named.conf -u named</span><br></pre></td></tr></table></figure>
<h2 id="3-1-named-root生成" class="article-heading"><a href="#3-1-named-root生成" class="headerlink" title="3.1 named.root生成"></a>3.1 named.root生成<a class="article-anchor" href="#3-1-named-root生成" aria-hidden="true"></a></h2><p>cd /var/named/<br>dig &gt; named.root<br>_or_<br>wget <a href="http://ftp.internic.net/domain/named.root" target="_blank" rel="noopener">http://ftp.internic.net/domain/named.root</a></p>
<p>## 生成rndc.conf（用于重载zonefile），并写入到named.conf（主配置文件）文件</p>
<ul>
<li><p>rndc-confgen &gt; /etc/rndc.conf<br>如果执行过程慢（由于rndc-confgen调用/dev/urandom，而/dev/urandom通过/proc/interrupts产生随机数不足，导致该命令一直等待）<br>可以指定随机数文件<br>rndc-confgen -r /dev/urandom &gt; /etc/rndc.conf</p>
</li>
<li><p>写入named.conf</p>
<figure class="highlight plain"><figcaption><span>-10</span><a href="/etc/rndc.conf">| head -9 | sed 's/\# //g' > /etc/named.conf```</a></figcaption><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">- 报错：</span><br><span class="line">&gt; May  3 00:52:54 cn-peking-dev-build named[19750]: the working directory is not writable</span><br><span class="line">May  3 00:52:54 cn-peking-dev-build named[19750]: managed-keys-zone: loading from master file **managed-keys.bind** failed: **permission denied**</span><br><span class="line">May  3 00:52:54 cn-peking-dev-build named[19750]: managed-keys.bind.jnl: open: permission denied</span><br><span class="line">May  3 00:52:54 cn-peking-dev-build named[19750]: managed-keys-zone: journal rollforward failed: unexpected error</span><br><span class="line">解法：</span><br><span class="line">cd /var/named</span><br><span class="line">touch managed-keys.bind</span><br><span class="line"></span><br><span class="line">## 3.2 BIND路径与chroot</span><br><span class="line">&gt; 所需文件:</span><br><span class="line"></span><br><span class="line">- /etc/named.conf</span><br><span class="line">- /var/named : 放zonefile</span><br><span class="line">- 权限named</span><br><span class="line">- zonefile : 主机名记录与IP对应</span><br><span class="line">- /var/run/named : named pid文件</span><br><span class="line"></span><br><span class="line">## 3.3 Cache-only和forwarding DNS</span><br><span class="line"></span><br><span class="line"> - Cache-only：仅有：&quot;.&quot;这个zonefile的简单dns，没有自己的dns服务器，只有缓存查询功能。</span><br><span class="line"> - Forwarding：指定上层dns服务器作为forwarding</span><br><span class="line"> - 如何设定：</span><br><span class="line">  &gt; 追加named.conf：</span><br><span class="line">    options &#123;</span><br><span class="line">        listen-on port 53 &#123; any; &#125;; # 系统默认对所有接口进行监听</span><br><span class="line">        directory        &quot;/var/named&quot;;</span><br><span class="line">        allow-query     &#123; any; &#125;; # 查询请求</span><br><span class="line">        recursion yes;</span><br><span class="line">        forward only; # 可以让dns服务器仅进行forwar，即使有.这个zonefile的设定也不会使用.的资料，只会将查询权交给上层dns</span><br><span class="line">        forwarders &#123; 114.114.114.114;119.29.29.29; &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">- rndc port 953远程控制</span><br><span class="line">&gt; rndc reload</span><br><span class="line"> </span><br><span class="line">- 抓包：</span><br><span class="line">&gt; tcpdump -K dst port 53</span><br><span class="line"></span><br><span class="line"># 4. DNS详解</span><br><span class="line">&gt; 几点注意：</span><br><span class="line"></span><br><span class="line">- DNS服务器需要在域名注册商处注册才能成为合法的DNS服务器</span><br><span class="line">- 配置文件以及目录位置</span><br><span class="line">- named主要配置文件：named.conf</span><br><span class="line">- 正反解都需要自己的zone文件，文件名由named.conf指定</span><br><span class="line">- 当dns查询时，若本身没有解析，则向root(.)或者forwarders服务器查询</span><br><span class="line">- debug：查看日志文件/var/log/messages</span><br><span class="line"></span><br><span class="line">    IN: 关键词搜索</span><br><span class="line">    RR type与RR data：</span><br><span class="line">    主机名  IN  A   IPv4</span><br><span class="line">    域名    IN  NS  nameserver</span><br><span class="line">    域名    IN  SOA 七参数</span><br><span class="line">    域名    IN  MX 数字 邮件服务器</span><br><span class="line">    主机别名    IN  CNAME   实际主机名</span><br><span class="line">    域名    IN  TXT 文本信息，以spf、_dmarc文本格式出现</span><br><span class="line"></span><br><span class="line">## 4.1.1 A、AAAA</span><br><span class="line"></span><br><span class="line">## 4.1.2 NS</span><br><span class="line">管理此域名的服务器主机名字</span><br><span class="line"></span><br><span class="line">## 4.1.3 SOA</span><br><span class="line">dig -t soa xxx.com</span><br><span class="line">管理此域名的服务器管理信息，七个重要参数</span><br><span class="line">多个DNS主机需要Master、slave，传递zonefile</span><br><span class="line"></span><br><span class="line">- Master DNS服务器主机名</span><br><span class="line">- 管理员的email（由于@在zonefile中有特殊含义，这里用.代替）</span><br><span class="line">- Serial：序列号YYMMDD00 改一次末尾数+1（Slave据此更新zonefile）</span><br><span class="line">- 刷新频率(refresh)：slave要求master更新（新版的bind中加入了notify功能，在需要的zone中加入此设定，master在更新完成某个zonefile后会主动发讯息给slave）</span><br><span class="line">- 失败重试（Retry）：如果slave因为某种原因无法从master更新数据，此时间为slave尝试重新连接master</span><br><span class="line">- 失效时间（Expire）：如果尝试一直失败，持续到达这个设定值，则不再重新连接，等待管理员处理</span><br><span class="line">- 缓存时间（TTL）： 没有在zonefile中写RR的TTL缓存时间，则以这个为准</span><br><span class="line"></span><br><span class="line">    Refresh &gt;= Retry * 2</span><br><span class="line">    Refresh + Retry &lt; Expire</span><br><span class="line">    Expire &gt;= Retry * 10</span><br><span class="line">    Expire &gt;= 7Days</span><br><span class="line">- 可以参考正规公司的值</span><br><span class="line">- aliyun vip dns&gt;&gt;: vip1.alidns.com. hostmaster.hichina.com. 2015120715 3600 1200 3600 360</span><br><span class="line"></span><br><span class="line">## 4.1.4 MX </span><br><span class="line">查询域名的邮件交换服务器主机名，数字代表优先次序，值越低表明有越高的邮件处理优先权</span><br><span class="line"></span><br><span class="line">## 4.1.5 TXT</span><br><span class="line">用来记录保存域名的附加文本信息，按照一定的格式书写，常见是spf格式，SPF用于登记某个域名拥有的用来外发邮件的所有IP地址。</span><br><span class="line">v=spf1 表示txt使用的是spf格式版本1</span><br><span class="line">include: ip4:</span><br><span class="line">~all 表示除了前面所指定的，其他IP统统不认可</span><br><span class="line"></span><br><span class="line">## 4.2 RR 反解</span><br><span class="line">PTR就是反解，查询IP对应的主机名，后面对应的是主机名，尽量使用FQDN，也就是末尾加上(.)。</span><br><span class="line">比如173.12.11.0/24，反解需要写成11.12.173.in-addr.arpa.这样的zone名称才行。</span><br><span class="line"></span><br><span class="line">## 4.3 DNS 规划</span><br><span class="line">ns1.xxx Master(NS,A)</span><br><span class="line">ns2.xxx Slave(NS,A)</span><br><span class="line"></span><br><span class="line">- 取消forwarders功能，禁止zonefile传输，</span><br><span class="line">&gt; options &#123;</span><br><span class="line">    directory &quot;/var/named&quot;;</span><br><span class="line">    pid-file &quot;named.pid&quot;;</span><br><span class="line">    forwarders &#123; 114.114.114.114; &#125;;</span><br><span class="line">    allow-query &#123; any &#125;;</span><br><span class="line">    allow-transfer &#123; none &#125;;</span><br><span class="line">&#125;;</span><br><span class="line">zone &quot;.&quot; IN &#123;</span><br><span class="line">    type hint;  # root</span><br><span class="line">    file &quot;named.root&quot;; # 已经下载</span><br><span class="line">&#125;</span><br><span class="line">zone &quot;etiantian.org&quot; IN &#123;</span><br><span class="line">    type master;</span><br><span class="line">    file &quot;etiantian.org.zone&quot;;</span><br><span class="line">    allow-update &#123; none; &#125;;</span><br><span class="line">    allow-transfer &#123; 192.168.120.209; &#125;; # slave</span><br><span class="line">    nitify yes;</span><br><span class="line">    also-notify &#123; 192.168.120.209; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line">zone &quot;120.168.192.in-addr.arpa&quot; IN &#123; #需要在运营商那里修改</span><br><span class="line">    type master;</span><br><span class="line">    file &quot;192.168.120.zone&quot;;</span><br><span class="line">    allow-transfer &#123; 192.168.120.209; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">## 4.4正解的设定</span><br><span class="line">注意：</span><br><span class="line">- 数据要从首行开始，前面不可以有空格</span><br><span class="line">- @代表zone的意思，在etiantian.org.zone中，@代表etiantian.org</span><br><span class="line">- 在192.168.120.zone中，@代表120.168.192.in-addr.arpa.</span><br><span class="line">- . 代表FQDN而不是仅有的hostname，在etiantian.org.zone中写www.etiantian.org则代表FQDN为 www.etiantian.org.@ ==&gt; www.etiantian.org.etiantian.org因此需要写成www.etiantian.org.或者www</span><br><span class="line"></span><br><span class="line">&gt; etiantian.org.zone</span><br><span class="line">$ttl 38400</span><br><span class="line">etiantian.org.  IN  SOA ns1.etiantian.org. webmaster.etiantian.org.     (</span><br><span class="line">    2016042400</span><br><span class="line">    10800</span><br><span class="line">    3600</span><br><span class="line">    604800</span><br><span class="line">    38400 )</span><br><span class="line">            IN  NS  ns1.etiantian.org.</span><br><span class="line">;            IN  NS  ns2.etiantian.org.</span><br><span class="line">ns1         IN  A   192.168.120.208</span><br><span class="line">;ns2         IN  A   192.168.120.209</span><br><span class="line">;@           IN  MX  192.168.120.209 #错误写法</span><br><span class="line">            IN  MX 10   mail</span><br><span class="line">mail        IN  A   192.168.120.209</span><br><span class="line"></span><br><span class="line">关于 .</span><br><span class="line">- 加了. 表示这是一个FQDN，即hostname + domain name，没加的话只表示domain name。</span><br><span class="line"></span><br><span class="line">## 4.5反解的设定</span><br><span class="line">反解和正解一样都需要TTL,SOA,NS，但是相对于正解，反解仅有PTR</span><br><span class="line">&gt; 192.168.120.zone</span><br><span class="line">$TTL 600</span><br><span class="line">@   IN  SOA ns1.etiantian.org. oldboy.etiantian.org. (</span><br><span class="line">    2016042400</span><br><span class="line">    1D</span><br><span class="line">    1H</span><br><span class="line">    1W</span><br><span class="line">    3H</span><br><span class="line">    )</span><br><span class="line">@   IN  NS  ns1.etiantian.org.</span><br><span class="line">208 IN  PTR ns1.etiantian.org.</span><br><span class="line">208 IN  PTR www.etiantian.org.</span><br><span class="line"></span><br><span class="line">- touch /var/named/touched_zone</span><br><span class="line">- named-checkconf /etc/named.conf</span><br><span class="line">- named-checkzone etiantian.org /var/named/etiantian.org.zone</span><br><span class="line">- named-checkzone 120.168.192.in-addr.arpa /var/named/192.168.120.zone</span><br><span class="line"></span><br><span class="line">## 4.6添加新的解析：</span><br><span class="line">- 针对要修改的zone，添加RR记录</span><br><span class="line">- 更改zonefile的serial，SOA的第三个参数</span><br><span class="line">- 重载named配置</span><br><span class="line"></span><br><span class="line"># 5 Slave DNS</span><br><span class="line">- 为了提供不间断dns服务，至少两部dns服务器供查询</span><br><span class="line">- 分散在不同的网段或者不同的机房</span><br><span class="line">- 一部master、其他为slave</span><br><span class="line">- slave本身无zonefile，其zonefile从master dns同步过来</span><br><span class="line">- 要传输的zonefile在named.conf中设定</span><br><span class="line"></span><br><span class="line">## 5.1.1 Master设定</span><br><span class="line">&gt; vim named.conf</span><br><span class="line">zone &quot;etiantian.org&quot; IN &#123;</span><br><span class="line">    type master;</span><br><span class="line">    file &quot;etiantian.org.zone&quot;;</span><br><span class="line">    **allow-transfer &#123; 192.168.120.209; &#125;;**</span><br><span class="line">&#125;;</span><br><span class="line">zone &quot;120.168.192.in-addr.arpa&quot; IN &#123;</span><br><span class="line">    type master;</span><br><span class="line">    file &quot;192.168.120.zone&quot;;</span><br><span class="line">    **allow-transfer &#123; 192.168.120.209; &#125;;**</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">## 5.1.2 在master的zonefile中添加A、NS、PTR记录（ns2）</span><br><span class="line">&gt; vim etiantian.org.zone 192.168.120.zone</span><br><span class="line">    IN  NS  ns2.etiantian.org.</span><br><span class="line">ns2 IN  A   192.168.120.209</span><br><span class="line">&lt;&lt;&lt;&lt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">209 IN  PTR ns2.etiantian.org.</span><br><span class="line"></span><br><span class="line">## 5.2 Slave设定</span><br><span class="line">&gt; vim named.conf</span><br><span class="line">zone &quot;etiantian.org&quot; IN &#123;</span><br><span class="line">    type slave;</span><br><span class="line">    file &quot;etiantian.org.zone&quot;;</span><br><span class="line">    master &#123; 192.168.120.208; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line">zone &quot;120.168.192.in-addr.arpa&quot; IN &#123;</span><br><span class="line">    type slave;</span><br><span class="line">    file &quot;192.168.120.zone&quot;;</span><br><span class="line">    master &#123; 192.168.120.208; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">## 5.3 在Master添加A记录</span><br><span class="line">&gt; vim etiantian.org.zone</span><br><span class="line">p   IN  A 192.168.120.208</span><br><span class="line">a.p   IN  A 192.168.120.208</span><br><span class="line">b.p   IN  A 192.168.120.208</span><br><span class="line">c.p   IN  A 192.168.120.208</span><br><span class="line"></span><br><span class="line">&gt; 更新RR记录，需要serial+1；更新zonefile需要rndc reload；修改named.conf需要重启named</span><br><span class="line"></span><br><span class="line"># 6 DNS View</span><br><span class="line">&gt; 视图</span><br><span class="line">根据用户来源不同而返回不同的查询结果，这个常用在cdn中，也是解决区域间带宽小和延迟大问题的解法。</span><br><span class="line"></span><br><span class="line">- 语法：</span><br><span class="line">在named.conf文件中，view配置如下：</span><br><span class="line">&gt; view &quot;internal&quot; &#123;</span><br><span class="line">&#125;;</span><br><span class="line">internal是区域名称，可自定义，需要唯一。</span><br><span class="line">区分区域通过match-clients关键字实现：</span><br><span class="line">&gt; view &quot;xxx&quot; &#123;</span><br><span class="line">    match-clients &#123; 10.0.0.0/25; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line">实现xxx视图只响应10.0.0.0/25段的请求；关键字**any**</span><br><span class="line">由于可能需要定义非常多的网段，BIND引入了**acl**关键字定义变量替换</span><br><span class="line">&gt; acl &quot;cnc&quot; &#123; 192.168.1/24;192.168.2/24; &#125;;</span><br><span class="line">view &quot;internal&quot; &#123;</span><br><span class="line">    match-clients &#123; &quot;cnc&quot;; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">- 常见：</span><br><span class="line">&gt; </span><br><span class="line">options &#123;</span><br><span class="line">&#125;;</span><br><span class="line">acl &quot;&quot; &#123;&#125;;</span><br><span class="line">view &quot;&quot; &#123;</span><br><span class="line">    match-clients &#123; &quot;&quot; &#125;;</span><br><span class="line">    zone &quot;&quot; &#123;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line">view &quot;&quot; &#123;</span><br><span class="line">    match-clients &#123; &quot;&quot; &#125;;</span><br><span class="line">    recursion no;</span><br><span class="line">    zone &quot;&quot; &#123;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">- 视图请求从上自下，如果请求的区域在上一个视图中，就不会向下一个视图请求，即使在下一个视图中放入了这个区域。</span><br><span class="line"></span><br><span class="line">- 从服务器IP配置。**因为在主服务器中划分了视图，不同来源区域被分配到不同的视图中处理，如果从服务器只有一个ip地址，从服务器就只能同步主服务器中单个视图中的zonefile。所以从服务器需要与主服务器视图数量相匹配的IP地址数量**</span><br><span class="line"></span><br><span class="line">- 默认情况下从服务器使用本地第一张网卡绑定的IP地址发送同步请求，如果不做调整，从服务器视图中仅同步第一张网卡的ip地址的主服务器视图信息。这时候我们需要在从服务器的视图中设置**transfer-source**关键字。</span><br><span class="line">&gt; transfer-source</span><br><span class="line">***transfer-source (ip4_addr | *) [port ip_port]; ]***</span><br><span class="line"></span><br><span class="line">如下是一个slave服务器视图named.conf文件：</span><br><span class="line">&gt; options &#123;</span><br><span class="line">&#125;;</span><br><span class="line">alc &quot;&quot; &#123;  &#125;;</span><br><span class="line">view &quot;&quot; &#123;</span><br><span class="line">    match-clients &#123; &quot;&quot;; &#125;;</span><br><span class="line">    **transfer-source 192.168.120.208;**</span><br><span class="line">    zone &quot;&quot; &#123;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">## 6.1 DNS View规划</span><br><span class="line">- named.conf ： 主配置文件</span><br><span class="line">&gt; include &quot;dx.cfg&quot;;</span><br><span class="line">include &quot;wt.cfg&quot;;</span><br><span class="line"></span><br><span class="line">- /var/named/dx/etiantian.org.zone</span><br><span class="line">- /var/named/wt/etiantian.org.zone</span><br><span class="line">- /var/named/others/etiantian.org.zone</span><br><span class="line"></span><br><span class="line">- /var/named/dx.cfg</span><br><span class="line">- /var/named/wt.cfg</span><br><span class="line"></span><br><span class="line">## 6.2 cfg文件</span><br><span class="line">&gt; vim dx.cfg</span><br><span class="line">acl dx &#123; ; &#125;;</span><br><span class="line">&gt; vim wt.cfg</span><br><span class="line">acl wt &#123; ; &#125;;</span><br><span class="line"></span><br><span class="line">## 6.3 Master zone配置文件</span><br><span class="line">&gt; vim wt/etiantian.org.zone</span><br><span class="line">$ttl 38400</span><br><span class="line">etiantian.org.  IN  SOA ns1.etiantian.org. webmaster.etiantian.org. (</span><br><span class="line">    2016042400</span><br><span class="line">    10800</span><br><span class="line">    3600</span><br><span class="line">    604800</span><br><span class="line">    38400)</span><br><span class="line">    IN  NS  ns1.etiantian.org.</span><br><span class="line">    IN  NS  ns2.etiantian.org.</span><br><span class="line">ns1 IN  A   192.168.120.208</span><br><span class="line">ns2 IN  A   192.168.120.209</span><br><span class="line">    IN  MX  10  mail</span><br><span class="line">www IN  A   192.168.120.20</span><br><span class="line">blog    IN  CNAME   www</span><br><span class="line">mail    IN  A   192.168.120.0</span><br><span class="line"></span><br><span class="line">## 6.4 验证</span><br><span class="line">- windows : nslookup www.etiantian.org 192.168.120.208</span><br><span class="line">- Linux : dig www.etiantian.org @192.168.120.208</span><br><span class="line"></span><br><span class="line">## 6.5 Slave</span><br><span class="line">三个view，需要三个ip去同步各个zonefile</span><br><span class="line">&gt; vim named.conf</span><br><span class="line">options &#123;</span><br><span class="line">&#125;;</span><br><span class="line">include &quot;dx.cfg&quot;;</span><br><span class="line">include &quot;wt.cfg&quot;;</span><br><span class="line">view &quot;wtzone&quot; &#123;</span><br><span class="line">    match-clients &#123; wt; 10.0.0.8; !10.0.0.9; !10.0.0.10; &#125;;</span><br><span class="line">    **transfer-source 10.0.0.8; # Master &gt;&gt; allow-transfer &#123; 10.0.0.8; &#125;;</span><br><span class="line">    allow-notify &#123; 10.0.0.8; &#125;;** # Master &gt;&gt; also-notify &#123; 10.0.0.8; &#125;;</span><br><span class="line">    recursion yes;</span><br><span class="line">zone &quot;.&quot; IN &#123;</span><br><span class="line">    type hint;</span><br><span class="line">    file &quot;named.root&quot;;</span><br><span class="line">&#125;;</span><br><span class="line">zone &quot;etiantian.org&quot; IN &#123;</span><br><span class="line">    type slave;</span><br><span class="line">    file &quot;wt/etiantian.org.zone&quot;;</span><br><span class="line">    masters &#123;  10.0.0.7; &#125;;         ## &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; Master</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line">view &quot;dxzone&quot; &#123;</span><br><span class="line">    match-clients &#123; wt; !10.0.0.8; 10.0.0.9; !10.0.0.10; &#125;;</span><br><span class="line">    **transfer-source 10.0.0.9;   # Master &gt;&gt; allow-transfer &#123; 10.0.0.9; &#125;;</span><br><span class="line">    allow-notify &#123; 10.0.0.9; &#125;; # Master &gt;&gt; also-notify &#123; 10.0.0.9; &#125;;**</span><br><span class="line">    recursion yes;</span><br><span class="line">zone &quot;.&quot; IN &#123;</span><br><span class="line">    type hint;</span><br><span class="line">    file &quot;named.root&quot;;</span><br><span class="line">&#125;;</span><br><span class="line">zone &quot;etiantian.org&quot; IN &#123;</span><br><span class="line">    type slave;</span><br><span class="line">    file &quot;dx/etiantian.org.zone&quot;;</span><br><span class="line">    masters &#123;  10.0.0.7; &#125;;         ## &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; Master</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line">view &quot;otherszone&quot; &#123;</span><br><span class="line">    match-clients &#123; any; !10.0.0.8; !10.0.0.9; 10.0.0.10; &#125;;</span><br><span class="line">    **transfer-source 10.0.0.10; # Master &gt;&gt; allow-transfer &#123; 10.0.0.10; &#125;;</span><br><span class="line">    allow-notify &#123; 10.0.0.10; &#125;; # Master &gt;&gt; also-notify &#123; 10.0.0.10; &#125;;**</span><br><span class="line">    recursion yes;</span><br><span class="line">zone &quot;etiantian.org&quot; IN &#123;</span><br><span class="line">    type slave;</span><br><span class="line">    file &quot;others/etiantian.org.zone&quot;;</span><br><span class="line">    masters &#123;  10.0.0.7; &#125;;         ## &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; Master</span><br><span class="line">&#125;;    </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&gt; 配置ip地址</span><br><span class="line"></span><br><span class="line">``` cp -ap ifconfig-eth1 ifconfig-eth1:0</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight plain"><figcaption><span>-ap ifconfig-eth1 ifconfig-eth1:1```</span></figcaption><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>DEVICE=eth1:0<br>BOOTPROTO=none<br>ONBOOT=yes<br>IPV6INIT=no<br>IPADDR=10.0.0.9<br><code>`</code></p>
<ul>
<li>ifconfig eth0:0 10.0.0.9 netmask 24</li>
<li>ifconfig eth0:1 10.0.0.10 netmask 24</li>
</ul>

  </div>
  
</article>

    </div>
  </div>
</div>
    <footer id="footer" class="wrapper">
  <div class="inner">
    <div id="footer-copyright">
      &copy; 2019 <a href="https://github.com/hexojs/hexo/graphs/contributors" target="_blank">W0ng.Unic0rn</a><br>
      Documentation licensed under <a href="http://creativecommons.org/licenses/by/4.0/" target="_blank">CC BY 4.0</a>.
    </div>
    <div id="footer-links">
      <a href="https://twitter.com/" class="footer-link" target="_blank"><i class="fa fa-twitter"></i></a>
      <a href="https://github.com/" class="footer-link" target="_blank"><i class="fa fa-github-alt"></i></a>
    </div>
  </div>
</footer>

  </div>
  <div id="mobile-nav-dimmer"></div>
  <nav id="mobile-nav">
  <div id="mobile-nav-inner">
    <ul id="mobile-nav-list">
      <a href="/zh-cn/docs/" class="mobile-nav-link">文档</a><a href="/zh-cn/api/" class="mobile-nav-link">API</a><a href="/news/" class="mobile-nav-link">新闻</a><a href="/plugins/" class="mobile-nav-link">插件</a><a href="/themes/" class="mobile-nav-link">主题</a>
      <li class="mobile-nav-item">
        <a href="https://github.com/" class="mobile-nav-link" rel="external" target="_blank">GitHub</a>
      </li>
    </ul>
    
  </div>
  <div id="mobile-lang-select-wrap">
    <span id="mobile-lang-select-label"><i class="fa fa-globe"></i><span>简体中文</span></span>
    <select id="mobile-lang-select" data-canonical="">
      
        <option value="en">English</option>
      
        <option value="zh-tw">正體中文</option>
      
        <option value="zh-cn" selected>简体中文</option>
      
        <option value="ru">Русский</option>
      
        <option value="ko">한국어</option>
      
        <option value="pt-br">Português (Brasil)</option>
      
        <option value="th">ภาษาไทย</option>
      
    </select>
  </div>
</nav>
  <!-- Scripts -->
<!-- Cookie -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.2.0/js.cookie.min.js"></script>
<!-- build:js build/js/main.js -->
<script src="/js/lang_select.js"></script>
<script src="/js/toc.js"></script>
<script src="/js/mobile_nav.js"></script>
<!-- endbuild -->

<!-- Algolia -->


</body>
</html>